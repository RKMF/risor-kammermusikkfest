---
import Layout from './Layout.astro';
import DynamicComponent from '../components/DynamicComponent.astro';
import { getMultilingualContent, detectLanguage } from '../lib/utils/language.js';
import { stegaClean } from '@sanity/client/stega';

interface Props {
  title: string;
  excerpt?: string;
  pageContent?: any[];
  pageDocument?: any; // Full document with multilingual content
}

const {
  title,
  excerpt,
  pageContent = [],
  pageDocument
} = Astro.props;

// Detect language from URL to use correct content
const language = detectLanguage(Astro.request);

// Get multilingual content if pageDocument is provided, otherwise use pageContent
const content = pageDocument
  ? (getMultilingualContent(pageDocument, language) || pageDocument?.content || pageContent)
  : pageContent;

// Extract slug information from pageDocument if available and clean stega encoding
const slugNo = pageDocument?.slug_no?.current ? stegaClean(pageDocument.slug_no.current) : undefined;
const slugEn = pageDocument?.slug_en?.current ? stegaClean(pageDocument.slug_en.current) : undefined;
---

<Layout title={`${title} - Sanity + Astro`} slugNo={slugNo} slugEn={slugEn}>
  <div class="stack page-layout" style="--space: var(--space-m-l)">
    <header class="page-header">
      <h1 class="page-title">
        {title}
      </h1>
      {excerpt && (
        <p class="page-excerpt">{excerpt}</p>
      )}
    </header>

    <!-- Page content from schema -->
    {content && Array.isArray(content) && content.length > 0 && (
      <div class="stack page-content" style="--space: var(--space-l-xl)">
        {content.map((block) => (
          <DynamicComponent key={block._key || block._id} block={block} />
        ))}
      </div>
    )}

    <!-- Main content slot (for listings, etc.) -->
    <slot />
  </div>
</Layout>

<style>
  /* ============================================
     INTRINSIC CONTENT PAGE LAYOUT
     ============================================

     Uses layout primitives (center, stack) for consistent,
     intrinsic responsive behavior.

     Key features:
     - Center primitive: Max-width constraint + centering
     - Stack primitive: Vertical rhythm with fluid spacing
     - Container query support for children
     - No media queries needed
  */

  .page-layout {
    /* Enable container queries for child components */
    container-type: inline-size;
    container-name: page-layout;

    /* Ensure content doesn't get too narrow on small screens */
    min-inline-size: min(100%, 280px);
  }

  .page-header {
    margin: 0;
  }

  .page-title {
    margin: 0 0 var(--space-4) 0;
    /* Use global h1 token for consistency across all h1 elements */
    font-size: var(--fs-3xl); /* Fluid 39-44px - matches global base.css h1 */
    /* Ensure title wraps gracefully with Norwegian/English text */
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
  }

  .page-excerpt {
    margin: 0 0 var(--space-3) 0;
    /* Accessible fluid typography: combines rem + vw for zoom support (WCAG 1.4.4) */
    font-size: clamp(1.25rem, 1.25rem + 0.25vw, 1.5rem);
    line-height: var(--line-height-relaxed);
    /* Better text balance for excerpts */
    text-wrap: balance;
    max-inline-size: 65ch; /* Optimal reading width */
  }

  .page-content {
    margin: 0;
    /* Stack pattern now handled by primitive class */
  }

  /* Fallback for browsers without container query support */
  @supports not (container-type: inline-size) {
    .page-layout {
      /* Traditional max-width pattern */
      max-inline-size: var(--container-max-width);
    }
  }
</style>