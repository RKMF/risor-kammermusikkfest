---
import Image from './Image.astro'
import Video from './Video.astro'
import Button from './Button.astro'
import Title from './Title.astro'
import Quote from './Quote.astro'
import Heading from './Heading.astro'
import PortableText from './PortableText.astro'

export interface Props {
  title?: string
  description?: string
  panels?: Array<{
    title: string
    content: any[]
  }>
  className?: string
}

const {
  title,
  description,
  panels = [],
  className = ''
} = Astro.props

// Generate unique ID for exclusive accordion behavior (prevents cross-accordion interference)
const accordionId = crypto.randomUUID?.() || Math.random().toString(36).slice(2, 11)

// Batch consecutive blocks together for cleaner HTML output
// Instead of wrapping each <p> in its own div, consecutive blocks render in one PortableText call
function batchContent(content: any[]) {
  const batched: Array<{ type: 'blocks'; items: any[] } | { type: 'component'; item: any }> = []
  let currentBlocks: any[] = []

  for (const item of content) {
    if (item._type === 'block') {
      currentBlocks.push(item)
    } else {
      // Flush accumulated blocks before adding component
      if (currentBlocks.length > 0) {
        batched.push({ type: 'blocks', items: currentBlocks })
        currentBlocks = []
      }
      batched.push({ type: 'component', item })
    }
  }

  // Flush remaining blocks
  if (currentBlocks.length > 0) {
    batched.push({ type: 'blocks', items: currentBlocks })
  }

  return batched
}
---

<section class={`accordion ${className}`}>
  {title && <h2 class="accordion-title">{title}</h2>}
  {description && <p class="accordion-description">{description}</p>}

  {panels && panels.length > 0 ? (
    panels.map((panel) => (
      <details class="accordion-panel" name={`accordion-${accordionId}`}>
        <summary class="accordion-summary">
          {panel.title}
        </summary>
        <div class="accordion-content">
          {panel.content && panel.content.length > 0 ? (
            batchContent(panel.content).map((batch) => {
              if (batch.type === 'blocks') {
                return <PortableText value={batch.items} className="accordion-text" />
              }
              const item = batch.item
              switch (item._type) {
                case 'imageComponent':
                  return <Image {...item} />
                case 'videoComponent':
                  return <Video {...item} />
                case 'buttonComponent':
                  return <Button {...item} />
                case 'title':
                  return <Title {...item} />
                case 'quoteComponent':
                  return <Quote {...item} />
                case 'heading':
                  return <Heading {...item} />
                default:
                  return <p>Ukjent komponent: {item._type}</p>
              }
            })
          ) : (
            <p>Ingen innhold</p>
          )}
        </div>
      </details>
    ))
  ) : (
    <p class="no-panels">Ingen paneler tilgjengelig</p>
  )}
</section>


<style>
  .accordion {
    width: min(85ch, 100%); /* Wider on big screens, but not full width */
    max-width: 100%;
    margin-inline: auto; /* Center it */
    margin-block: var(--space-xl-2xl); /* Fluid section spacing */
    background: var(--color-yellow-100); /* Light yellow background for entire component */
    padding: var(--space-m-l); /* Padding around entire accordion */
  }

  .accordion-title {
    margin: 0 0 var(--space-s) 0;
    font-size: var(--step-3);
    font-weight: var(--font-weight-semibold);
    color: var(--color-yellow-900);
  }

  .accordion-description {
    max-width: 70ch;
    margin-bottom: var(--space-l);
    line-height: var(--line-height-normal);
    color: var(--color-yellow-900); /* Dark yellow text to match theme */
    text-wrap: balance;
  }

  .accordion-panel {
    margin-bottom: var(--space-s); /* Space between panels */
  }

  .accordion-panel:last-child {
    margin-bottom: 0; /* No margin on last panel */
  }

  .accordion-summary {
    padding: var(--space-m) var(--space-m-l); /* Fluid padding */
    padding-inline-end: 3rem; /* Reserve space for arrow (1.5rem position + arrow width) */
    background: var(--color-yellow-50); /* Light yellow tint */
    color: var(--color-yellow-900); /* Dark yellow text */
    cursor: pointer;
    font-weight: var(--font-weight-medium); /* 500 */
    transition: background-color 0.2s ease;
    list-style: none;
    position: relative;
  }

  /* Remove default marker */
  .accordion-summary::-webkit-details-marker {
    display: none;
  }

  .accordion-summary::after {
    content: '';
    position: absolute;
    right: 1.5rem;
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
    width: 8px;
    height: 8px;
    border-right: 2px solid var(--color-yellow-900);
    border-bottom: 2px solid var(--color-yellow-900);
    transition: transform 0.2s ease;
  }

  .accordion-panel[open] .accordion-summary::after {
    transform: translateY(-50%) rotate(-135deg);
  }

  .accordion-summary:hover {
    background: var(--color-red-50); /* Red tint on hover - matches card hover pattern */
  }

  .accordion-summary:active {
    background: var(--color-red-100); /* Slightly darker red on click */
  }

  .accordion-summary:focus {
    outline: 2px solid var(--color-yellow-900);
    outline-offset: -2px;
  }

  .accordion-panel {
    background: var(--color-yellow-50); /* Fill entire panel with yellow to prevent green flash */
  }

  /* Progressive enhancement: Smooth accordion animation in modern browsers (Baseline 2025) */
  .accordion-panel::details-content {
    transition: content-visibility 0.5s ease-out, height 0.5s ease-out;
  }

  /* Content wrapper - single padding, gap controls spacing between items */
  .accordion-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-m);
    padding: var(--space-m) var(--space-m-l);
    background: var(--color-yellow-50);
    color: var(--color-yellow-900);
  }

  /* Reset margins on direct children - gap controls spacing */
  .accordion-content > * {
    margin-block: 0;
  }

  /* Override content-narrow width restriction - accordion has its own padding */
  .accordion-content :global(.accordion-text) {
    width: 100%;
    max-inline-size: none;
  }

  .no-panels {
    padding: var(--space-m) var(--space-m-l); /* Fluid padding */
    text-align: center;
  }
</style> 