---
import { IMAGE_QUALITY, getOptimizedImageUrl, getResponsiveImageSet } from '../lib/sanityImage';
import { stegaClean } from '@sanity/client/stega';
import type { ArtistResult } from '../lib/sanity/queries';

interface Props {
  artist: ArtistResult;
  language?: 'no' | 'en';
  size?: 'large' | 'medium';
  isDetailPage?: boolean;
  imageSizes?: string;
}

const { artist, language = 'no', size = 'medium', isDetailPage = false, imageSizes = '320px' } = Astro.props;

// Determine artist link based on language
const artistPath = language === 'en'
  ? `/en/artists/${stegaClean(artist.slug)}`
  : `/artister/${stegaClean(artist.slug)}`;

// Size-specific image dimensions and aspect ratios
// Large cards: full width image (320px), 3:4 aspect ratio (takes 3/4 of 9:16 card)
// Medium cards: full width image (320px), takes 2/3 of 4:5 card (2fr:1fr grid)
const sizeConfig = {
  large: { width: 320, height: 427, aspectRatio: 3/4 },      // 3:4 (320รท0.75=427)
  medium: { width: 320, height: 267, aspectRatio: 320/267 }, // 2/3 of 400px height
};

const { width, height, aspectRatio } = sizeConfig[size];

// CSS class based on size variant
const sizeClass = size === 'medium' ? 'artist-card--medium' : '';

// Split name for two-line display (first name(s) on line 1, surname on line 2)
function formatNameForCard(name: string): string {
  const cleanName = stegaClean(name);
  const lastSpaceIndex = cleanName.lastIndexOf(' ');
  if (lastSpaceIndex === -1) return cleanName; // Single name, no split
  return cleanName.slice(0, lastSpaceIndex) + '<br>' + cleanName.slice(lastSpaceIndex + 1);
}
---

<!-- Hidden SVG for wave clip-path definitions -->
<svg width="0" height="0" style="position: absolute;" aria-hidden="true">
  <defs>
    <!-- Medium cards - top shallow wave pattern from logo (line 7) -->
    <clipPath id="artist-wave-clip-medium" clipPathUnits="objectBoundingBox">
      <path d="M 0 0.015 C 0.035 0.006, 0.077 0, 0.136 0 C 0.234 0, 0.286 0.01, 0.333 0.022 C 0.377 0.033, 0.415 0.048, 0.499 0.048 C 0.583 0.048, 0.621 0.033, 0.665 0.022 C 0.712 0.01, 0.764 0, 0.862 0 C 0.921 0, 0.963 0.006, 0.998 0.015 L 1 0.015 L 1 1 L 0 1 Z" />
    </clipPath>
  </defs>
</svg>

<article class={`artist-card ${sizeClass}`.trim()}>
  {!isDetailPage && (
    <h3 class="artist-title">
      <a href={artistPath} class="artist-title-link card-link">
        {stegaClean(artist.name)}
      </a>
    </h3>
  )}

  {artist.image?.image && (
    <img
      src={getOptimizedImageUrl(artist.image.image, width, height, IMAGE_QUALITY.CARD)}
      srcset={getResponsiveImageSet(artist.image.image, [320, 480, 640], aspectRatio, IMAGE_QUALITY.CARD)}
      sizes={imageSizes}
      alt={stegaClean(artist.image.alt) || stegaClean(artist.name)}
      width={width.toString()}
      height={height.toString()}
      loading={isDetailPage ? "eager" : "lazy"}
      decoding="async"
      class="artist-card-image"
      style={isDetailPage && artist.image.image.asset?.metadata?.lqip
        ? `background-image: url(${artist.image.image.asset.metadata.lqip}); background-size: cover;`
        : undefined}
    />
  )}

  <div class="artist-info-box">
    <p class="artist-name" set:html={formatNameForCard(artist.name)} />
    {artist.instrument && (
      <p class="artist-instrument">{stegaClean(artist.instrument)}</p>
    )}
  </div>

  {/* Wave ribbon bottom border - exact path from Symbol_RKMF.svg line 7 (shallow wave) */}
  {size === 'large' && (
    <svg class="artist-card-wave" viewBox="132 104 586 106" preserveAspectRatio="none" aria-hidden="true">
      <path d="M738.52,117.1c-21.88-7.53-48.47-13.07-85.36-13.07-61.15,0-94.08,15.17-123.95,29.5-27.38,13.14-51.19,24.71-104.02,24.71s-76.64-11.57-104.02-24.71c-29.86-14.33-62.8-29.5-123.95-29.5-36.9,0-63.49,5.54-85.36,13.07v45.14c21.15-9.19,44.42-16.03,85.36-16.03,52.83,0,76.25,11.37,103.63,24.51,29.86,14.33,63.18,29.7,124.33,29.7s94.47-15.37,124.33-29.7c27.38-13.14,50.8-24.51,103.63-24.51,40.94,0,64.22,6.84,85.36,16.03v-45.14h.02Z" fill="currentColor"/>
    </svg>
  )}
</article>
