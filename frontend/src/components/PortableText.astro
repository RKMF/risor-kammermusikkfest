---
import { PortableText } from 'astro-portabletext';
import type { PortableTextBlock } from '@portabletext/types';

/**
 * PortableText wrapper component for rendering Sanity rich text content.
 *
 * This component provides a semantic-neutral wrapper (<div>) for PortableText content.
 * The parent component should provide semantic context (e.g., <article>, <section>).
 *
 * @example
 * ```astro
 * <!-- Parent provides semantic context -->
 * <article class="artist-bio">
 *   <h1>{artist.name}</h1>
 *   <PortableText value={artist.content_no} />
 * </article>
 * ```
 */
interface Props {
  /** PortableText blocks from Sanity */
  value?: PortableTextBlock[];
  /** Alias for 'value' (compatibility) */
  content?: PortableTextBlock[];
  /** Additional CSS classes */
  className?: string;
  /** Custom component renderers (merged with defaults) */
  components?: any;
  /** Sanity Visual Editing field annotation */
  'data-sanity-field'?: string;
}

const {
  value,
  content,
  className = '',
  components: customComponents,
  'data-sanity-field': sanityField,
  ...restProps
} = Astro.props;

// Handle both 'value' and 'content' props for compatibility
const contentToRender = value || content || [];

// Default components - can be overridden by parent
const defaultComponents = {
  types: {
    // Custom types can be added here or passed via components prop
  },
  marks: {
    // Custom link renderer for proper handling of openInNewTab
    link: ({ value, children }: any) => {
      const { href, openInNewTab } = value || {};
      const target = openInNewTab ? '_blank' : undefined;
      const rel = openInNewTab ? 'noopener noreferrer' : undefined;

      return {
        tag: 'a',
        attrs: {
          href,
          target,
          rel,
        },
        children,
      };
    },
  },
  block: {
    // Custom block rendering if needed
  }
};

// Merge custom components with defaults
const components = customComponents
  ? { ...defaultComponents, ...customComponents }
  : defaultComponents;
---

<!-- Semantic-neutral wrapper - parent component provides semantic context -->
<div
  class={`portable-text content-narrow ${className}`}
  {...(sanityField && { 'data-sanity-field': sanityField })}
  {...restProps}
>
  {contentToRender && contentToRender.length > 0 && (
    <PortableText value={contentToRender} components={components} />
  )}
</div>

<style>
  .portable-text {
    line-height: 1.6;
  }
  
  .portable-text h2 {
    /* Aligned with base.css: --step-3 (31-35px responsive) */
    font-size: var(--step-3);
    font-weight: 600;
    margin-block: var(--space-l) var(--space-m); /* Fluid spacing */
  }

  .portable-text h3 {
    /* Aligned with base.css: --step-2 (25-28px responsive) */
    font-size: var(--step-2);
    font-weight: 600;
    margin-block: var(--space-m-l) var(--space-s-m); /* Fluid spacing */
  }

  .portable-text h4 {
    /* Aligned with base.css: --step-1 (20-23px responsive) */
    font-size: var(--step-1);
    font-weight: 600;
    margin-block: var(--space-s-m) var(--space-xs-s); /* Fluid spacing */
  }
  
  .portable-text p {
    margin-block: var(--space-m); /* Fluid spacing */
  }

  .portable-text blockquote {
    border-left: 4px solid #e5e5e5;
    padding-left: var(--space-m); /* Fluid spacing */
    margin-block: var(--space-m-l); /* Fluid spacing */
    font-style: italic;
  }

  .portable-text ul,
  .portable-text ol {
    margin-block: var(--space-m); /* Fluid spacing */
    padding-left: var(--space-m-l); /* Fluid spacing */
  }
  
  .portable-text li {
    margin: 0.5rem 0;
  }
  
  .portable-text code {
    background: #f5f5f5;
    padding: 0.2rem 0.4rem;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
  }
  
  .portable-text strong {
    font-weight: 600;
  }
  
  .portable-text em {
    font-style: italic;
  }
</style> 