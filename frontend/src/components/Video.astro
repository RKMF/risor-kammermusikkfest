---
import { detectLanguage } from '../lib/utils/language.js';

export interface Props {
  videoType: 'sanity' | 'youtube' | 'vimeo' | 'external'
  video?: any
  youtubeUrl?: string
  vimeoUrl?: string
  externalUrl?: string
  aspectRatio?: string
  title?: string
  description?: string
  autoplay?: boolean
  muted?: boolean
  controls?: boolean
  loop?: boolean
  className?: string
}

const {
  videoType,
  video,
  youtubeUrl,
  vimeoUrl,
  externalUrl,
  aspectRatio = '16:9',
  title,
  description,
  autoplay = false,
  muted = true,
  controls = true,
  loop = false,
  className = ''
} = Astro.props

// Calculate aspect ratio
const [width, height] = aspectRatio.split(':').map(Number)
const aspectRatioValue = `${width}/${height}`

// Helper functions to extract video IDs
function extractYouTubeId(url: string): string | null {
  if (!url) return null
  const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/)
  return match ? match[1] : null
}

function extractVimeoId(url: string): string | null {
  if (!url) return null
  const match = url.match(/vimeo\.com\/(\d+)/)
  return match ? match[1] : null
}

// Generate video source based on type
let videoSource = ''
let videoId = ''

switch (videoType) {
  case 'youtube':
    if (youtubeUrl) {
      videoId = extractYouTubeId(youtubeUrl) || ''
      // Use privacy-enhanced mode (youtube-nocookie.com)
      videoSource = `https://www.youtube-nocookie.com/embed/${videoId}`
    }
    break
  case 'vimeo':
    if (vimeoUrl) {
      videoId = extractVimeoId(vimeoUrl) || ''
      videoSource = `https://player.vimeo.com/video/${videoId}`
    }
    break
  case 'external':
    videoSource = externalUrl || ''
    break
  case 'sanity':
    videoSource = video?.asset?.url || ''
    break
}

// Language-specific text
const language = detectLanguage(Astro.request);
const videoText = {
  no: {
    browserNotSupported: 'Din nettleser støtter ikke HTML5 video.',
    youtubeTitle: 'Innebygd YouTube-video',
    vimeoTitle: 'Innebygd Vimeo-video',
    loadError: 'Kunne ikke laste video'
  },
  en: {
    browserNotSupported: 'Your browser does not support HTML5 video.',
    youtubeTitle: 'Embedded YouTube video',
    vimeoTitle: 'Embedded Vimeo video',
    loadError: 'Could not load video'
  }
}[language];
---

{videoType && videoSource ? (
  <figure class={`video-component ${className}`} data-component="video">
    {videoType === 'sanity' && (
      <video
        controls={controls}
        autoplay={autoplay}
        muted={muted}
        loop={loop}
        preload="none"
        playsinline
        class="video-element"
        aria-label={title || 'Video'}
        style={`aspect-ratio: ${aspectRatioValue};`}
      >
        <source src={videoSource} type="video/mp4" />
        {/* Future: Add <track> elements for captions/subtitles */}
        {videoText.browserNotSupported}
      </video>
    )}

    {videoType === 'youtube' && (
      <iframe
        loading="lazy"
        src={`${videoSource}?autoplay=${autoplay ? 1 : 0}&mute=${muted ? 1 : 0}&controls=${controls ? 1 : 0}&loop=${loop ? 1 : 0}&rel=0`}
        title={title || videoText.youtubeTitle}
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowFullscreen
        class="video-element"
        style={`aspect-ratio: ${aspectRatioValue};`}
      ></iframe>
    )}

    {videoType === 'vimeo' && (
      <iframe
        loading="lazy"
        src={`${videoSource}?autoplay=${autoplay ? 1 : 0}&muted=${muted ? 1 : 0}&controls=${controls ? 1 : 0}&loop=${loop ? 1 : 0}&dnt=1`}
        title={title || videoText.vimeoTitle}
        allow="autoplay; fullscreen; picture-in-picture"
        allowFullscreen
        class="video-element"
        style={`aspect-ratio: ${aspectRatioValue};`}
      ></iframe>
    )}

    {videoType === 'external' && (
      <video
        controls={controls}
        autoplay={autoplay}
        muted={muted}
        loop={loop}
        preload="none"
        playsinline
        class="video-element"
        aria-label={title || 'Video'}
        style={`aspect-ratio: ${aspectRatioValue};`}
      >
        <source src={videoSource} type="video/mp4" />
        {/* Future: Add <track> elements for captions/subtitles */}
        {videoText.browserNotSupported}
      </video>
    )}

    {(title || description) && (
      <figcaption class="video-caption">
        {title && description ? (
          <>
            <strong class="video-caption-title">{title}</strong>
            {' — '}
            {description}
          </>
        ) : title ? (
          title
        ) : (
          description
        )}
      </figcaption>
    )}
  </figure>
) : (
  <div class="video-error" role="alert">
    <p>{videoText.loadError}</p>
  </div>
)}

<style>
  /* CSS Variable-based width control - Kevin Powell method */
  .video-component {
    width: var(--component-width, min(55ch, 100% - 4rem));
    max-width: var(--component-max-width, 100%);
    margin-inline: auto;
    margin-block: var(--space-l); /* Fluid 24px → 30px */
  }

  /* Reset margin when inside scroll containers to prevent overflow */
  :global(.scroll-item) .video-component {
    margin: 0;
  }

  /* When inside a layout context, fill parent space */
  :global([data-layout-context]) .video-component {
    width: 100%;
    height: 100%;
    margin: 0;
    display: flex;
    flex-direction: column;
  }

  :global([data-layout-context]) .video-element {
    width: 100%;
    height: 100%;
    flex: 1;
  }

  .video-title {
    /* Migrated to fluid token: --step-1 (20-23px responsive) */
    font-size: var(--step-1);
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .video-description {
    margin-bottom: 1rem;
    line-height: 1.6;
  }

  .video-element {
    width: 100%;
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  /* Inside scroll containers: width calculated from height + aspect-ratio */
  :global(.scroll-item) .video-element {
    width: auto;
    height: 100%;
  }

  /* For video-elementer (Sanity og ekstern) */
  .video-element[src] {
    object-fit: cover;
    object-position: center;
  }

  .video-error {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-l);
    background: var(--color-yellow-50);
    border: 2px solid var(--color-yellow-200);
    text-align: center;
  }

  /* Note: Removed viewport media query for margin - now uses fluid spacing token that adapts automatically */

  .video-caption {
    margin-top: 0.75rem;
    /* Migrated to fluid token: --step--1 (13-14px responsive) */
    font-size: var(--step--1);
    line-height: 1.5;
  }

  .video-caption-title {
    font-weight: 600;
  }

  /* Tilgjengelighet */
  .video-element:focus {
    outline: 2px solid #0066cc;
    outline-offset: 2px;
  }
</style> 