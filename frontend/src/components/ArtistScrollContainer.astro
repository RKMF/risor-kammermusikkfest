---
import { sanityClient } from "sanity:client";
import ArtistCard from './ArtistCard.astro';
import { detectLanguage } from '../lib/utils/language.js';

interface Props {
  title?: string
  items?: any[]
  showScrollbar?: boolean
}

const {
  title,
  items = [],
  showScrollbar = false
} = Astro.props

// Detect current language from URL
const currentLanguage = detectLanguage(Astro.request)

// Hent faktiske artist-data fra referansene
let artistData = []
if (items && items.length > 0) {
  const artistIds = items.map((item: any) => item._ref).filter(Boolean)
  if (artistIds.length > 0) {
    const ARTIST_QUERY = `*[_type == "artist" && _id in $artistIds]{
      _id,
      _type,
      name,
      "slug": slug.current,
      excerpt_no,
      excerpt_en,
      "excerpt": coalesce(excerpt_no, excerpt_en),
      instrument_no,
      instrument_en,
      "instrument": coalesce(instrument_no, instrument_en),
      country,
      "image": {
        "image": image{
          asset->{
            _id,
            url,
            metadata {
              dimensions {
                width,
                height,
                aspectRatio
              },
              lqip,
              blurHash,
              palette {
                dominant {
                  background,
                  foreground
                }
              }
            }
          },
          hotspot,
          crop
        },
        "alt": coalesce(imageAlt_no, imageAlt_en, image.alt),
        "credit": coalesce(imageCredit_no, imageCredit_en)
      },
      publishingStatus,
      scheduledPeriod,
      instagram,
      facebook,
      spotify,
      youtube,
      websiteUrl,
      spotifyUrl,
      instagramUrl,
      seo
    }`
    artistData = await sanityClient.fetch(ARTIST_QUERY, { artistIds })
  }
}

// CSS-klasser basert på props
const containerClass = 'artist-scroll-container'
const scrollbarClass = showScrollbar ? '' : 'hide-scrollbar'
---

<section class={`${containerClass} ${scrollbarClass}`}>
  {title && <h2 class="artist-scroll-title">{title}</h2>}
  <ul class="artist-list scroll-container scroll-container--artist-cards">
    {artistData.map((artist) => {
        if (!artist) return null

        return (
          <li class="artist-item">
            <ArtistCard artist={artist} language={currentLanguage} size="medium" />
          </li>
        )
      })}
  </ul>
</section>

<style>
  /* Scroll Container */
  .artist-scroll-container {
    container-type: inline-size;
    width: min(100ch, 100% - 4rem);
    margin-inline: auto;
    margin-block: var(--space-m-l); /* Fluid 16px → 30px */
  }

  .artist-scroll-title {
    font-size: var(--step-3);
    font-weight: 600;
    margin-block-end: var(--space-m);
  }

  /* Scroll list - behavior from scroll-containers.css */
  .artist-list {
    list-style: none;
    margin: 0;
    padding-block: var(--space-2);
  }

  .artist-item {
    /* Container for ArtistCard component */
    display: contents;
  }

  /* Hide scrollbar variant */
  .hide-scrollbar .artist-list.scroll-container {
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding-block-end: 0;
  }

  .hide-scrollbar .artist-list.scroll-container::-webkit-scrollbar {
    display: none;
  }

  /* Support for reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .artist-list.scroll-container {
      scroll-behavior: auto;
    }
  }
</style>
