---
import DynamicComponent from './DynamicComponent.astro'

export interface Props {
  title?: string
  column1: any[]
  column2: any[]
  column3: any[]
  aspectRatio?: '4:5' | '9:16' | '1:1'
  className?: string
  _key?: string
  _type?: string
}

const {
  title,
  column1 = [],
  column2 = [],
  column3 = [],
  aspectRatio = '4:5',
  className = '',
  _key,
  _type,
} = Astro.props

const item1 = column1[0]
const item2 = column2[0]
const item3 = column3[0]

// Convert aspectRatio string to CSS value
const aspectMap: Record<string, string> = {
  '4:5': '4 / 5',
  '9:16': '9 / 16',
  '1:1': '1 / 1',
}
const aspectValue = aspectMap[aspectRatio] || '4 / 5'

// Sanity Visual Editing attributes
const sanityAttributes = _key ? { 'data-sanity': `${_type}.${_key}` } : {}
---

{title && <h2 class="section-title">{title}</h2>}

<section
  class={`three-column-layout content-wide ${className}`}
  data-layout-context="three-column"
  style={`--column-aspect-ratio: ${aspectValue}`}
  {...sanityAttributes}
>
    <div class="column column-1">
      {item1 && <DynamicComponent block={item1} />}
    </div>

    <div class="column column-2">
      {item2 && <DynamicComponent block={item2} />}
    </div>

    <div class="column column-3">
      {item3 && <DynamicComponent block={item3} />}
    </div>
</section>

<style>
  .section-title {
    margin-block-end: var(--space-l-xl); /* Fluid 24px → 40px */
    font-size: var(--fs-2xl);
    font-weight: 600;
  }

  .three-column-layout {
    display: grid;
    /* Intrinsic: creates up to 3 columns when space allows, stacks when narrow */
    grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr));
    gap: var(--space-l-xl); /* Fluid 24px → 40px */
    margin-block: var(--space-xl-2xl); /* Fluid 32px → 60px section spacing */
    align-items: start;

    /* Container query context - allows children to adapt to available space */
    container-type: inline-size;
    container-name: three-column-layout;
  }

  .column {
    width: 100%;
    aspect-ratio: var(--column-aspect-ratio, 4 / 5);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 300px; /* Prevent tiny boxes */

    /* Performance optimizations */
    contain: layout style paint;
    content-visibility: auto;
  }

  /* Media content: Fill and crop */
  .column > :global(.image-container),
  .column > :global([data-component="video"]) {
    width: 100%;
    height: 100%;
    flex: 1;
  }

  .column > :global(.image-container .image),
  .column > :global(.image) {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Components that fill column space and respect aspect ratio */
  .column > :global([data-component="spotify"]),
  .column > :global([data-component="quote"]),
  .column > :global([data-component="video"]) {
    width: 100%;
    height: 100%;
    flex: 1;
  }

  /* Text content: Scrollable within aspect ratio */
  .column > :global([data-component="quote"]),
  .column > :global([data-component="text"]),
  .column > :global(.portable-text) {
    overflow-y: auto;
    height: 100%;
    padding: var(--space-m-l); /* Fluid 16px → 30px */

    /* Custom scrollbar styling */
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
  }

  .column > :global([data-component="quote"])::-webkit-scrollbar,
  .column > :global([data-component="text"])::-webkit-scrollbar,
  .column > :global(.portable-text)::-webkit-scrollbar {
    width: 8px;
  }

  .column > :global([data-component="quote"])::-webkit-scrollbar-thumb,
  .column > :global([data-component="text"])::-webkit-scrollbar-thumb,
  .column > :global(.portable-text)::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
  }

  /* Nested layouts: Natural height */
  .column > :global([data-layout-context]) {
    aspect-ratio: auto;
    overflow: visible;
    height: auto;
    contain: none;
  }

  /* Container query: Adjust gap when columns reduce */
  @container three-column-layout (max-width: 900px) {
    .three-column-layout {
      gap: var(--space-m-l); /* Slightly smaller gap when fewer columns */
    }
  }

  /* Note: No viewport media queries needed! Columns automatically reflow based on 280px minimum width */
  /* Grid intrinsically adapts: 3 columns → 2 columns → 1 column based on available space */

  /* Accessibility */
  .column:focus-within {
    outline: 2px solid #0066cc;
    outline-offset: 4px;
  }

  /* Print styles */
  @media print {
    .three-column-layout {
      display: block;
    }

    .column {
      page-break-inside: avoid;
      margin-block-end: var(--space-m);
      aspect-ratio: auto;
      overflow: visible;
      contain: none;
      min-height: auto;
    }

    .column > :global([data-component="quote"]) {
      overflow-y: visible;
      height: auto;
    }
  }
</style>
