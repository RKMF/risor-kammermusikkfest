---
import { sanityClient } from "sanity:client";
import { detectLanguage } from "../lib/utils/language.js";
import { formatDateForLanguage } from '../lib/utils/dates';
import { getOptimizedImageUrl, getResponsiveImageSet, IMAGE_QUALITY } from '../lib/sanityImage';
import ScrollNavigation from './ScrollNavigation.astro';
import { stegaClean } from '@sanity/client/stega';

interface Props {
  title?: string
  items?: any[]
  showScrollbar?: boolean
  sortBy?: 'date-asc' | 'date-desc' | 'title-asc' | 'manual'
}

const {
  title,
  items = [],
  showScrollbar = false,
  sortBy = 'date-desc'
} = Astro.props

// Detect current language from URL
const currentLanguage = detectLanguage(Astro.request)

// Language-specific config
const config = {
  no: {
    basePath: '/artikler/',
    slugPreference: (article: any) => article.slug_no?.current || article.slug_en?.current,
    ariaLabel: 'Artikler',
    scrollAriaLabel: 'Bla gjennom artikler',
  },
  en: {
    basePath: '/en/articles/',
    slugPreference: (article: any) => article.slug_en?.current || article.slug_no?.current,
    ariaLabel: 'Articles',
    scrollAriaLabel: 'Scroll through articles',
  }
}[currentLanguage]

// Fetch actual article data from references
let articleData: any[] = []
if (items && items.length > 0) {
  const articleIds = items.map((item: any) => item._ref).filter(Boolean)
  if (articleIds.length > 0) {
    const ARTICLE_QUERY = `*[_type == "article" && _id in $articleIds]{
      _id,
      _type,
      title_no,
      title_en,
      "title": coalesce(title_no, title_en),
      slug_no,
      slug_en,
      excerpt_no,
      excerpt_en,
      "excerpt": coalesce(excerpt_no, excerpt_en),
      "image": {
        "image": image{
          asset->{
            _id,
            url,
            metadata {
              dimensions {
                width,
                height,
                aspectRatio
              },
              lqip,
              palette {
                dominant {
                  background,
                  foreground
                }
              }
            }
          },
          hotspot,
          crop
        },
        "alt": coalesce(imageAlt_no, imageAlt_en, image.alt),
        "credit": coalesce(imageCredit_no, imageCredit_en)
      },
      publishedAt,
      publishingStatus,
      scheduledPeriod
    }`
    articleData = await sanityClient.fetch(ARTICLE_QUERY, { articleIds })
  }
}

// Sort articles based on selected sort option
let sortedArticles = [...articleData]
switch (sortBy) {
  case 'date-asc':
    sortedArticles.sort((a, b) => {
      const dateA = a.publishedAt ? new Date(a.publishedAt) : new Date(0)
      const dateB = b.publishedAt ? new Date(b.publishedAt) : new Date(0)
      return dateA.getTime() - dateB.getTime()
    })
    break
  case 'date-desc':
    sortedArticles.sort((a, b) => {
      const dateA = a.publishedAt ? new Date(a.publishedAt) : new Date(0)
      const dateB = b.publishedAt ? new Date(b.publishedAt) : new Date(0)
      return dateB.getTime() - dateA.getTime()
    })
    break
  case 'title-asc':
    sortedArticles.sort((a, b) => (a.title || '').localeCompare(b.title || ''))
    break
  case 'manual':
  default:
    // Keep manual order based on reference array order
    const orderMap = new Map(items.map((item: any, index: number) => [item._ref, index]))
    sortedArticles.sort((a, b) => {
      const orderA = orderMap.get(a._id) ?? Infinity
      const orderB = orderMap.get(b._id) ?? Infinity
      return orderA - orderB
    })
    break
}

// CSS classes based on props
const containerClass = 'article-scroll-container'
const scrollbarClass = showScrollbar ? '' : 'hide-scrollbar'
---

<section class={`${containerClass} ${scrollbarClass}`}>
  {title && <h2 class="article-scroll-title">{title}</h2>}
  <div class="scroll-container-wrapper">
    <ul
      class="article-list scroll-container scroll-container--always scroll-container--article-cards scroll-container--styled-scrollbar"
      tabindex="0"
      aria-label={config.ariaLabel}
    >
      {sortedArticles.map((article) => {
          if (!article) return null

          const articleTitle = stegaClean(article.title)
          const articleExcerpt = article.excerpt ? stegaClean(article.excerpt) : null
          const articleSlug = stegaClean(config.slugPreference(article))
          const articleLink = `${config.basePath}${articleSlug}`

          return (
            <li class="article-item">
              <article class="article-card card">
                <h3 class="article-title">
                  <a href={articleLink} class="article-title-link card-link">
                    {articleTitle}
                  </a>
                </h3>

                {articleExcerpt && (
                  <p class="article-excerpt">{articleExcerpt}</p>
                )}

                {article.image?.image && (
                  <figure class="article-image">
                    <img
                      src={getOptimizedImageUrl(article.image.image, 320, 180, IMAGE_QUALITY.CARD)}
                      srcset={getResponsiveImageSet(article.image.image, [320, 640, 960], 16/9, IMAGE_QUALITY.CARD)}
                      sizes="(min-width: 1000px) 50ch, (min-width: 700px) 40ch, min(100%, 350px)"
                      alt={stegaClean(article.image.alt || articleTitle)}
                      width="320"
                      height="180"
                      loading="lazy"
                      decoding="async"
                      class="article-card-image"
                    />
                  </figure>
                )}

                {article.publishedAt && (
                  <div class="article-meta">
                    <span class="article-date">
                      {formatDateForLanguage(article.publishedAt, currentLanguage)}
                    </span>
                  </div>
                )}
              </article>
            </li>
          )
        })}
    </ul>
  </div>
  <ScrollNavigation size="medium" ariaLabel={config.scrollAriaLabel} />
</section>

<style>
  /* Scroll Container */
  .article-scroll-container {
    container-type: inline-size;
    padding-block: var(--space-5);
  }

  .article-scroll-title {
    font-size: var(--step-3);
    font-weight: 600;
    margin-block-end: var(--space-m);
  }

  /* Scroll list - behavior from scroll-containers.css */
  .article-list {
    list-style: none;
    margin: 0;
    padding-block: var(--space-2);
    padding-inline: 0;
  }

  .article-item {
    /* Container for article card */
    display: contents;
  }

  /* Article Card - matches ArticlePageContent styling exactly */
  .article-card {
    position: relative;
    container-type: inline-size;
    display: grid;
    grid-template-rows: auto auto minmax(120px, 1fr) auto;
    overflow: hidden;
    border: none;
    background-color: rgba(27, 25, 143, 0.08);
    box-shadow: none;
    transition: transform 200ms var(--ease-standard),
                box-shadow 200ms var(--ease-standard),
                background-color 200ms var(--ease-standard);
    padding: var(--space-4);
    gap: var(--space-3);
    /* Same as listing page, adapted for scroll container */
    width: min(50ch, 90vw);
    aspect-ratio: 10 / 9;
    flex-shrink: 0;
  }

  /* Hover effect only for devices with hover capability */
  @media (hover: hover) {
    .article-card:hover {
      transform: translateY(-4px);
      box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px;
      background-color: rgba(0, 179, 154, 0.08);
    }

    .article-card:hover .article-title-link {
      color: var(--color-blue);
    }
  }

  .article-title {
    margin: 0;
    font-size: clamp(var(--step-2), 1.25rem + 1.875cqi, var(--step-3));
    line-height: 1.2;
    font-weight: 600;
    font-family: var(--font-family-heading);
    text-transform: none;
    letter-spacing: -0.01em;

    /* Space for Norwegian diacritics (Å, Ø, Æ) to prevent clipping */
    padding-block-start: 0.15em;

    /* Clamp to max 2 lines with ellipsis */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;

    /* Overflow protection for long words */
    overflow-wrap: break-word;
    word-wrap: break-word;
    hyphens: none;
  }

  /* Fallback for browsers without container query unit support */
  @supports not (font-size: 1cqi) {
    .article-title {
      font-size: var(--step-3);
    }
  }

  .article-excerpt {
    margin: 0;
    margin-top: 0.25rem;
    font-size: var(--step-0);
    line-height: var(--line-height-compact);

    /* Two line truncation with ellipsis */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;

    /* Force exact height to prevent line peek-through */
    max-height: calc(1.5em * 2);

    /* Overflow protection for long words */
    overflow-wrap: break-word;
    word-wrap: break-word;
    hyphens: none;
  }

  figure.article-image {
    position: relative;
    width: 100%;
    max-height: 100%;
    aspect-ratio: 16/9;
    overflow: hidden;
    align-self: center;
    justify-self: center;
    margin: 0;
  }

  figure.article-image picture {
    display: block;
    width: 100%;
    height: 100%;
  }

  .article-card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .article-meta {
    font-size: var(--step--1);
    margin: 0;
    position: relative;
    z-index: 0;
  }

  .article-date {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  /* Hide scrollbar on touch devices only (mouse users need scrollbar) */
  @media (pointer: coarse) {
    .hide-scrollbar .article-list.scroll-container {
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding-block-end: 0;
    }

    .hide-scrollbar .article-list.scroll-container::-webkit-scrollbar {
      display: none;
    }
  }

  /* Support for reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .article-list.scroll-container {
      scroll-behavior: auto;
    }
  }
</style>
