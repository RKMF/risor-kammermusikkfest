---
export interface Props {
  targetDate: string;
  title?: string;
  style?: 'large' | 'compact' | 'minimal';
  completedMessage?: string;
  hideWhenComplete?: boolean;
}

const {
  targetDate: targetDateStr,
  title,
  style = 'compact',
  completedMessage = 'Tiden er ute!',
  hideWhenComplete = false
} = Astro.props;

// Calculate time remaining server-side for initial render
function getTimeRemaining(targetDate: Date) {
  const now = new Date();
  const diff = targetDate.getTime() - now.getTime();

  if (diff <= 0) {
    return { expired: true, days: 0, hours: 0, minutes: 0 };
  }

  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

  return { days, hours, minutes, expired: false };
}

// Default time remaining
let timeRemaining = { expired: true, days: 0, hours: 0, minutes: 0 };
let updateInterval = '60s';

// Parse the target date (ISO datetime string from Sanity)
if (targetDateStr) {
  const targetDate = new Date(targetDateStr);
  timeRemaining = getTimeRemaining(targetDate);

  // Determine update frequency based on time remaining
  updateInterval = timeRemaining.days > 1
    ? '3600s' // Update every hour when > 1 day
    : '60s';   // Update every minute when < 1 day
}

// Don't render if expired and hideWhenComplete is true
if (timeRemaining.expired && hideWhenComplete) {
  return null;
}
---

<section class={`countdown countdown--${style}`}>
  <div
    class="countdown__display"
    role={timeRemaining.expired ? "status" : "timer"}
    aria-live="polite"
    aria-atomic="true"
    aria-label={timeRemaining.expired ? completedMessage : `Nedtelling: ${timeRemaining.days ? `${timeRemaining.days} dager, ` : ''}${timeRemaining.hours ? `${timeRemaining.hours} timer og ` : ''}${timeRemaining.minutes} minutter igjen`}
  >
    {timeRemaining.expired ? (
      <p class="countdown__expired">
        {completedMessage}
      </p>
    ) : (
      <p class="countdown__sentence">
        {title && <span class="countdown__prefix">{title} </span>}
        {timeRemaining.days > 0 && (
          <>
            <span class="countdown__number">{timeRemaining.days}</span>
            <span class="countdown__label"> {timeRemaining.days === 1 ? 'dag' : 'dager'}</span>
            {(timeRemaining.hours > 0 || timeRemaining.minutes > 0) && <span class="countdown__separator">, </span>}
          </>
        )}
        {timeRemaining.hours > 0 && (
          <>
            <span class="countdown__number">{timeRemaining.hours}</span>
            <span class="countdown__label"> {timeRemaining.hours === 1 ? 'time' : 'timer'}</span>
            {timeRemaining.minutes > 0 && <span class="countdown__separator"> og </span>}
          </>
        )}
        {timeRemaining.minutes > 0 && (
          <>
            <span class="countdown__number">{timeRemaining.minutes}</span>
            <span class="countdown__label"> {timeRemaining.minutes === 1 ? 'minutt' : 'minutter'}</span>
          </>
        )}
      </p>
    )}
  </div>
</section>

<style>
  .countdown {
    text-align: center;
    padding: var(--space-m-l);
    background-color: var(--color-tint-blue-medium);
    max-width: 40ch;
    margin-inline: auto;
  }

  .countdown__display {
    position: relative;
  }

  .countdown__sentence {
    margin: 0;
    font-size: var(--step-1);
    line-height: 1.4;
  }

  .countdown__prefix {
    font-weight: 400;
  }

  .countdown__number {
    font-weight: 700;
  }

  .countdown__label {
    font-weight: 400;
  }

  .countdown__separator {
    font-weight: 400;
  }

  /* Style variations */
  .countdown--large .countdown__sentence {
    font-size: var(--step-2);
  }

  .countdown--large .countdown__number {
    font-size: var(--step-3);
  }

  .countdown--minimal {
    padding: var(--space-m);
    background: none;
    border: none;
  }

  .countdown--minimal .countdown__sentence {
    font-size: var(--step-0);
  }

  .countdown__expired {
    margin: 0;
    font-size: var(--step-1);
    font-weight: 600;
  }

  @media (prefers-contrast: high) {
    .countdown {
      outline: 2px solid #000;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .countdown {
      background-color: var(--color-tint-blue-medium);
    }
  }
</style>
