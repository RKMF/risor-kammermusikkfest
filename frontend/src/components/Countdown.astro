---
export interface Props {
  targetDate: string;
  title?: string;
  style?: 'large' | 'compact' | 'minimal';
  completedMessage?: string;
  hideWhenComplete?: boolean;
}

const {
  targetDate: targetDateStr,
  title,
  style = 'compact',
  completedMessage = 'Tiden er ute!',
  hideWhenComplete = false
} = Astro.props;

// Calculate time remaining server-side for initial render
function getTimeRemaining(targetDate: Date) {
  const now = new Date();
  const diff = targetDate.getTime() - now.getTime();

  if (diff <= 0) {
    return { expired: true, days: 0, hours: 0, minutes: 0 };
  }

  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

  return { days, hours, minutes, expired: false };
}

// Default time remaining
let timeRemaining = { expired: true, days: 0, hours: 0, minutes: 0 };
let updateInterval = '60s';

// Parse the target date (ISO datetime string from Sanity)
if (targetDateStr) {
  const targetDate = new Date(targetDateStr);
  timeRemaining = getTimeRemaining(targetDate);

  // Determine update frequency based on time remaining
  updateInterval = timeRemaining.days > 1
    ? '3600s' // Update every hour when > 1 day
    : '60s';   // Update every minute when < 1 day
}

// Don't render if expired and hideWhenComplete is true
if (timeRemaining.expired && hideWhenComplete) {
  return null;
}
---

<section class={`countdown countdown--${style}`}>
  <div
    class="countdown__display"
    role={timeRemaining.expired ? "status" : "timer"}
    aria-live="polite"
    aria-atomic="true"
    aria-label={timeRemaining.expired ? completedMessage : `Nedtelling: ${timeRemaining.days ? `${timeRemaining.days} dager, ` : ''}${timeRemaining.hours ? `${timeRemaining.hours} timer og ` : ''}${timeRemaining.minutes} minutter igjen`}
  >
    {timeRemaining.expired ? (
      <p class="countdown__expired">
        {completedMessage}
      </p>
    ) : (
      <>
        {title && <p class="countdown__title">{title}</p>}
        <p class="countdown__timer">
          {timeRemaining.days > 0 && (
            <>
              <span class="countdown__number">{timeRemaining.days}</span>
              <span class="countdown__label"> {timeRemaining.days === 1 ? 'dag' : 'dager'}</span>
              {timeRemaining.hours > 0 && <span class="countdown__separator"> og </span>}
            </>
          )}
          {timeRemaining.hours > 0 && (
            <>
              <span class="countdown__number">{timeRemaining.hours}</span>
              <span class="countdown__label"> {timeRemaining.hours === 1 ? 'time' : 'timer'}</span>
            </>
          )}
        </p>
      </>
    )}
  </div>
</section>

<style>
  .countdown {
    text-align: center;
    background-color: var(--color-green-100);
    padding: 1.5em 2em;
    max-width: 60ch;
    margin-inline: auto;
    color: var(--color-green-800);
  }

  .countdown__display {
    position: relative;
  }

  .countdown__title {
    margin: 0 0 var(--space-xs) 0;
    font-size: var(--step-3);
    font-weight: 400;
    line-height: 1.2;
  }

  .countdown__timer {
    margin: 0;
    font-size: var(--step-3);
    line-height: 1.3;
  }

  .countdown__number {
    font-weight: 700;
  }

  .countdown__label {
    font-weight: 400;
  }

  .countdown__separator {
    font-weight: 400;
  }

  /* Style variations */
  .countdown--large .countdown__title {
    font-size: var(--step-3);
  }

  .countdown--large .countdown__timer {
    font-size: var(--step-4);
  }

  .countdown--minimal .countdown__title {
    font-size: var(--step-1);
  }

  .countdown--minimal .countdown__timer {
    font-size: var(--step-2);
  }

  .countdown__expired {
    margin: 0;
    font-size: var(--step-2);
    font-weight: 600;
  }
</style>
