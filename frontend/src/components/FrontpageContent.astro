---
import Layout from '../layouts/Layout.astro';
import DynamicComponent from './DynamicComponent.astro';
import Countdown from './Countdown.astro';
import { createDataService } from '../lib/sanity/dataService.js';
import { getMultilingualContent } from '../lib/utils/language.js';
import { stegaClean } from '@sanity/client/stega';
import { resolveLinkUrl } from '../lib/buildInternalUrl';
import { sanityClient } from 'sanity:client';
import { QueryBuilder } from '../lib/sanity/queryBuilder.js';

interface Props {
  language: 'no' | 'en';
}

const { language } = Astro.props;

// Language-specific configuration
const config = {
  no: {
    fallbackTitle: 'Forside',
    headerLinksField: 'headerLinks_no' as const,
    ariaLogoLabel: 'Risør Kammermusikkfest',
    ariaNavLabel: 'Hovedlenker',
    emptyTitle: 'Velkommen til forsiden',
    emptyText: 'Ingen forside er konfigurert ennå. Gå til Sanity Studio for å opprette en forside.',
    tagline: 'Den beste musikken,<br />med de beste artistene,<br />i den beste sommerbyen!',
  },
  en: {
    fallbackTitle: 'Home',
    headerLinksField: 'headerLinks_en' as const,
    ariaLogoLabel: 'Risor Chamber Music Festival',
    ariaNavLabel: 'Main links',
    emptyTitle: 'Welcome to the homepage',
    emptyText: 'No homepage is configured yet. Go to Sanity Studio to create a homepage.',
    tagline: 'The best music,<br />with the best artists,<br />in the best summer town!',
  }
}[language];

// Create data service with Visual Editing support
const dataService = createDataService(Astro.request);

// Load homepage using data service
const homepage = await dataService.getHomepage();

const homepageTitle = homepage?.title || config.fallbackTitle;

// Smart caching based on content type
if (homepage?.scheduledPeriod) {
  const timeUntilExpiry = new Date(homepage.scheduledPeriod.endDate).getTime() - Date.now();
  const cacheTime = Math.min(timeUntilExpiry / 1000, 300); // Max 5 minutes
  Astro.response.headers.set('Cache-Control', `public, max-age=${cacheTime}`);
} else {
  Astro.response.headers.set('Cache-Control', 'public, max-age=3600'); // 1 hour
}

// Get language-specific content
const content = homepage ? (getMultilingualContent(homepage, language) || homepage?.content || []) : [];

// Extract header links using config field name
const headerLinks = homepage?.[config.headerLinksField] || [];
const hasHeaderLinks = headerLinks.length > 0;

// Extract slug information
const slugNo = homepage?.slug_no?.current ? stegaClean(homepage.slug_no.current) : undefined;
const slugEn = homepage?.slug_en?.current ? stegaClean(homepage.slug_en.current) : undefined;

// Fetch logo SVG from Sanity and process colors
let tekstLogoSvg = '';
try {
  const { query: logoQuery, params: logoParams } = QueryBuilder.siteSettingsTekstLogo();
  const logoData = await sanityClient.fetch<{ tekstLogo?: { image?: { asset?: { url?: string } } } }>(logoQuery, logoParams);
  const logoUrl = logoData?.tekstLogo?.image?.asset?.url;

  if (logoUrl) {
    const response = await fetch(logoUrl);
    if (response.ok) {
      let svgContent = await response.text();
      // Replace all fill colors with currentColor for CSS control
      svgContent = svgContent.replace(/fill:\s*rgb\([^)]+\)/g, 'fill:currentColor');
      svgContent = svgContent.replace(/fill:\s*#[0-9a-fA-F]{3,6}/g, 'fill:currentColor');
      tekstLogoSvg = svgContent;
    }
  }
} catch (error) {
  console.error('Failed to fetch logo SVG:', error);
}
---

<Layout
  title={homepageTitle}
  description={homepage?.excerpt ? stegaClean(homepage.excerpt) : undefined}
  slugNo={slugNo}
  slugEn={slugEn}
  frontpage
  seo={homepage?.seo}
  image={homepage?.image?.image}
  ogType="website"
>
  <div class="stack page-layout" style="--space: var(--space-xl)">
    {!homepage && (
      <div class="no-content">
        <h1>{config.emptyTitle}</h1>
        <p>{config.emptyText}</p>
      </div>
    )}

    {/* Hero section - logo always shown, links conditional */}
    {tekstLogoSvg && (
      <>
        <h1 class="homepage-tagline" set:html={config.tagline} />
        <div class={`homepage-hero ${hasHeaderLinks ? 'homepage-hero--with-links' : ''}`}>
        <div class="tekst-logo-container">
          <div
            class="tekst-logo"
            role="img"
            aria-label={config.ariaLogoLabel}
            set:html={tekstLogoSvg}
          />
        </div>

        {hasHeaderLinks && (
          <nav class="header-links" aria-label={config.ariaNavLabel}>
            {headerLinks.map((link) => (
              <div class="header-link-item">
                <a
                  href={resolveLinkUrl(link, language)}
                  class="header-link hover-underline"
                >
                  <span class="header-link__text">{link.text} →</span>
                </a>
                {link.description && (
                  <p class="header-link__description">{link.description}</p>
                )}
              </div>
            ))}
          </nav>
        )}
      </div>
      </>
    )}

    {/* Temporary hardcoded countdown for testing */}
    <Countdown
      targetDate="2026-06-23T12:00:00"
      title="Festivalen starter om"
    />

    {/* PageBuilder content - rendered below hero */}
    {content && Array.isArray(content) && content.length > 0 && (
      <div class="homepage-content">
        {content.map((block) => (
          <DynamicComponent key={block._key || block._id} block={block} />
        ))}
      </div>
    )}
  </div>
</Layout>

<style>
  .no-content {
    margin: 0;
  }

  /* Homepage tagline - h1 above hero */
  .homepage-tagline {
    font-size: clamp(var(--step-2), 5vw, var(--step-4));
    text-align: center;
    margin-block: var(--space-l) var(--space-l);
    color: var(--color-blue);
    max-width: 20ch;
    margin-inline: auto;
  }

  /* Page layout styling */
  .page-layout {
    container-type: inline-size;
    container-name: page-layout;
    min-inline-size: min(100%, 280px);
  }

  /* Hero section - blue box with logo and CTA links */
  .homepage-hero {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-m);
    align-items: start;
    margin-block: var(--space-l);
    background-color: var(--color-tint-blue-medium);
    padding: var(--space-l);
  }

  /* On desktop with links, logo and links side by side */
  @media (min-width: 769px) {
    .homepage-hero--with-links {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-l);
      align-items: center;
    }
  }

  .tekst-logo-container {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Logo - fluid sizing, color controlled by token */
  .tekst-logo {
    width: 100%;
    max-width: clamp(280px, 50vw, 400px);
    aspect-ratio: 4 / 5;
    color: var(--color-blue);
  }

  .tekst-logo :global(svg) {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Opera browser fix - font-size-adjust breaks SVG text rendering */
  :global(body.is-opera) .tekst-logo :global(svg) {
    font-size-adjust: none;
  }

  /* Header links - matching Link.astro styling */
  .header-links {
    display: flex;
    flex-direction: column;
    gap: var(--space-s-m);
    padding-inline-start: var(--space-s);
  }

  .header-link-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xs);
  }

  .header-link {
    display: inline-flex;
    align-items: center;
    padding: var(--space-2xs) var(--space-xs);
    font-weight: var(--font-weight-medium);
    font-size: var(--step-3);
    line-height: var(--line-height-heading);
    background-image: none;
  }


  .header-link:focus-visible {
    background-color: var(--color-tint-blue-light);
  }

  .header-link__description {
    margin: 0;
    font-size: var(--step-0);
    color: var(--color-text-secondary);
    line-height: 1.5;
    padding-inline-start: calc(var(--space-xs) + var(--space-s));
  }

  /* PageBuilder content below hero */
  .homepage-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-l);
  }
</style>

<script>
  // Detect Opera browser and add class for CSS targeting
  // Opera's user agent contains "OPR/" (not "Opera" which is legacy)
  if (navigator.userAgent.includes('OPR/')) {
    document.body.classList.add('is-opera');
  }
</script>
