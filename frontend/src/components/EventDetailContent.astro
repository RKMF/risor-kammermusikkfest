---
import Layout from '../layouts/Layout.astro';
import DynamicComponent from '../components/DynamicComponent.astro';
import HeaderImage from '../components/HeaderImage.astro';
import ArtistCard from '../components/ArtistCard.astro';
import ComposerCard from '../components/ComposerCard.astro';
import Spotify from '../components/Spotify.astro';
import PortableText from '../components/PortableText.astro';
import EventSchema from '../components/structured-data/EventSchema.astro';
import { formatDateWithWeekday } from '../lib/utils/dates';
import { getMultilingualContent } from '../lib/utils/language.js';
import { IMAGE_QUALITY } from '../lib/sanityImage';
import { stegaClean } from '@sanity/client/stega';
import '../styles/event.css';
import '../styles/artist-card.css';
import '../styles/composer-card.css';

interface Props {
  event: any;
  language: 'no' | 'en';
}

const { event, language } = Astro.props;

// Language-specific configuration
const config = {
  no: {
    date: 'Dato',
    time: 'Tid',
    venue: 'Sted',
    free: 'Gratis',
    buyTickets: 'Kjøp billetter her',
    aboutConcert: 'Om konserten',
    listenMusic: 'Hør musikken',
    additionalContent: 'Tilleggsinnhold',
    composers: 'Komponister',
    artists: 'Artister',
    descriptionField: 'description_no',
    extraContentField: 'extraContent_no'
  },
  en: {
    date: 'Date',
    time: 'Time',
    venue: 'Venue',
    free: 'Free',
    buyTickets: 'Buy tickets',
    aboutConcert: 'About the concert',
    listenMusic: 'Listen to the music',
    additionalContent: 'Additional Content',
    composers: 'Composers',
    artists: 'Artists',
    descriptionField: 'description_en',
    extraContentField: 'extraContent_en'
  }
}[language];

// Get appropriate content arrays
const description = getMultilingualContent(event, language, 'description') || event[config.descriptionField];
const extraContent = getMultilingualContent(event, language, 'extraContent') || event[config.extraContentField];
---

<Layout
  title={stegaClean(event.title || '')}
  description={stegaClean(event.excerpt || '')}
  slugNo={event.slug_no?.current}
  slugEn={event.slug_en?.current}
  seo={event.seo}
  image={event.image?.image || event.image}
  ogType="event"
>
  <!-- Structured Data: MusicEvent Schema -->
  <EventSchema event={event} lang={language} />

  <article class="event-page">
      <header class="event-info-box">
        <div class="event-header">
          <hgroup>
            <h1 class="event-title">{stegaClean(event.title || '')}</h1>
            {event.excerpt && (
              <p class="event-excerpt">{stegaClean(event.excerpt)}</p>
            )}
          </hgroup>

          <dl class="event-meta">
            {event.eventDate?.date && (
              <>
                <dt class="sr-only">{config.date}</dt>
                <dd>
                  <time datetime={event.eventDate.date}>
                    {stegaClean(formatDateWithWeekday(event.eventDate.date, language))}
                  </time>
                </dd>
              </>
            )}
            {event.eventTime && (
              <>
                <dt class="sr-only">{config.time}</dt>
                <dd>
                  <time datetime={event.eventTime.startTime}>{stegaClean(event.eventTime.startTime)}</time>–<time datetime={event.eventTime.endTime}>{stegaClean(event.eventTime.endTime)}</time>
                </dd>
              </>
            )}
            {event.venue?.title && (
              <>
                <dt class="sr-only">{config.venue}</dt>
                <dd>{stegaClean(event.venue.title)}</dd>
              </>
            )}
          </dl>
        </div>

        {stegaClean(event.ticketType) === 'info' ? (
          <p class="ticket-info">{stegaClean(event.ticketInfoText) || config.free}</p>
        ) : (
          <a href={stegaClean(event.ticketUrl)} class="btn btn-primary" target="_blank" rel="noopener noreferrer" data-track-ticket data-concert={stegaClean(event.title)}>
            {config.buyTickets}
          </a>
        )}
      </header>

      <section class="main-event-info">
        {event.image?.image?.asset && (
          <HeaderImage
            image={event.image.image}
            alt={stegaClean(event.image.alt || event.title || '')}
            credit={event.image.credit ? stegaClean(event.image.credit) : undefined}
            aspectRatio="4:3"
            loading="eager"
            quality={IMAGE_QUALITY.CARD}
            width="100%"
          />
        )}

        {description && (
          <div class="event-description">
            <h2 class="section-title">{config.aboutConcert}</h2>
            {Array.isArray(description) ? (
              <PortableText value={description} className="description-text" />
            ) : (
              <p class="description-text">{stegaClean(description)}</p>
            )}
          </div>
        )}
      </section>

      {event.spotifyItems && event.spotifyItems.length > 0 && (
        <section class="spotify-section">
          <h2 class="spotify-title">{config.listenMusic}</h2>
          <ul class="scroll-container scroll-container--always scroll-container--spotify scroll-container--styled-scrollbar">
            {event.spotifyItems.map((item) => (
              <li><Spotify {...item} height={152} /></li>
            ))}
          </ul>
        </section>
      )}

      {extraContent && Array.isArray(extraContent) && extraContent.length > 0 && (
        <section class="pagebuilder-content">
          <h2 class="sr-only">{config.additionalContent}</h2>
          {extraContent.map((block) => (
            <DynamicComponent key={block._key || block._id} block={block} />
          ))}
        </section>
      )}

      {event.composers && event.composers.length > 0 && (
        <section class="composers-section">
          <h2 class="composers-title">{config.composers}</h2>
          <div class="composer-section scroll-container scroll-container--always scroll-container--styled-scrollbar">
            {event.composers.map((composer) => (
              <ComposerCard composer={composer} lang={language} />
            ))}
          </div>
        </section>
      )}

      {event.artists && event.artists.filter(Boolean).length > 0 && (
        <section class="artists-section">
          {/* Hidden SVG for wave clip-path definitions */}
          <svg width="0" height="0" style="position: absolute;" aria-hidden="true">
            <defs>
              {/* Large cards - line 6 wave pattern with two peaks and one valley */}
              <clipPath id="artist-wave-clip-large" clipPathUnits="objectBoundingBox">
                <path d="M 0 0.06 C 0.08 0.06, 0.12 0.04, 0.17 0.015 C 0.22 0, 0.28 0, 0.33 0.015 C 0.38 0.03, 0.42 0.06, 0.5 0.06 C 0.58 0.06, 0.62 0.03, 0.67 0.015 C 0.72 0, 0.78 0, 0.83 0.015 C 0.88 0.04, 0.92 0.06, 1 0.06 L 1 1 L 0 1 Z"/>
              </clipPath>

              {/* Medium cards - top shallow wave pattern from logo (line 7) */}
              <clipPath id="artist-wave-clip-medium" clipPathUnits="objectBoundingBox">
                <path d="M 0 0.015 C 0.035 0.006, 0.077 0, 0.136 0 C 0.234 0, 0.286 0.01, 0.333 0.022 C 0.377 0.033, 0.415 0.048, 0.499 0.048 C 0.583 0.048, 0.621 0.033, 0.665 0.022 C 0.712 0.01, 0.764 0, 0.862 0 C 0.921 0, 0.963 0.006, 0.998 0.015 L 1 0.015 L 1 1 L 0 1 Z" />
              </clipPath>
            </defs>
          </svg>

          <h2 class="artists-title">{config.artists}</h2>
          <div class="artist-section scroll-container scroll-container--always scroll-container--artist-cards scroll-container--styled-scrollbar">
            {event.artists.filter(Boolean).map((artist) => (
              <ArtistCard artist={artist} language={language} size="medium" />
            ))}
          </div>
        </section>
      )}
  </article>
</Layout>
