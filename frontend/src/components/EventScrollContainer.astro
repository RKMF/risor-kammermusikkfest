---
import { sanityClient } from "sanity:client";
import { detectLanguage } from "../lib/utils/language.js";
import EventCard from './EventCard.astro';
import ScrollNavigation from './ScrollNavigation.astro';
import type { EventResult } from '../lib/sanity/queries';

interface Props {
  title?: string
  events?: any[]
  showScrollbar?: boolean
  sortBy?: 'date-asc' | 'date-desc' | 'title-asc' | 'manual'
}

const {
  title,
  events = [],
  showScrollbar = false,
  sortBy = 'date-asc'
} = Astro.props

// Detect current language from URL
const currentLanguage = detectLanguage(Astro.request)

// Fetch actual event data from references
let eventData: EventResult[] = []
if (events && events.length > 0) {
  const eventIds = events.map((item: any) => item._ref).filter(Boolean)
  if (eventIds.length > 0) {
    const EVENT_QUERY = `*[_type == "event" && _id in $eventIds]{
      _id,
      _type,
      title_no,
      title_en,
      "title": coalesce(title_no, title_en),
      slug_no,
      slug_en,
      excerpt_no,
      excerpt_en,
      "excerpt": coalesce(excerpt_no, excerpt_en),
      "image": {
        "image": image{
          asset->{
            _id,
            url,
            metadata {
              dimensions {
                width,
                height,
                aspectRatio
              },
              lqip,
              palette {
                dominant {
                  background,
                  foreground
                }
              }
            }
          },
          hotspot,
          crop
        },
        "alt": coalesce(imageAlt_no, imageAlt_en, image.alt),
        "credit": coalesce(imageCredit_no, imageCredit_en)
      },
      eventDate->{
        _id,
        date,
        title_display_no,
        title_display_en,
        "title": coalesce(title_display_no, title_display_en)
      },
      eventTime,
      venue->{
        _id,
        title,
        name,
        address,
        city,
        "slug": slug.current
      },
      ticketType,
      ticketUrl,
      ticketInfoText,
      ticketStatus,
      publishingStatus,
      scheduledPeriod,
      seo
    }`
    eventData = await sanityClient.fetch(EVENT_QUERY, { eventIds })
  }
}

// Sort events based on selected sort option
let sortedEvents = [...eventData]
switch (sortBy) {
  case 'date-asc':
    sortedEvents.sort((a, b) => {
      const dateA = a.eventDate?.date ? new Date(a.eventDate.date) : new Date(0)
      const dateB = b.eventDate?.date ? new Date(b.eventDate.date) : new Date(0)
      return dateA.getTime() - dateB.getTime()
    })
    break
  case 'date-desc':
    sortedEvents.sort((a, b) => {
      const dateA = a.eventDate?.date ? new Date(a.eventDate.date) : new Date(0)
      const dateB = b.eventDate?.date ? new Date(b.eventDate.date) : new Date(0)
      return dateB.getTime() - dateA.getTime()
    })
    break
  case 'title-asc':
    sortedEvents.sort((a, b) => (a.title || '').localeCompare(b.title || ''))
    break
  case 'manual':
  default:
    // Keep manual order (no sorting)
    break
}

// CSS classes based on props
const containerClass = 'event-scroll-container'
const scrollbarClass = showScrollbar ? '' : 'hide-scrollbar'
---

<section class={`${containerClass} ${scrollbarClass}`}>
  {title && <h2 class="event-scroll-title">{title}</h2>}
  <div class="scroll-container-wrapper">
    <ul
      class="event-list scroll-container scroll-container--always scroll-container--event-cards scroll-container--styled-scrollbar"
      tabindex="0"
      aria-label={currentLanguage === 'no' ? 'Arrangementer' : 'Events'}
    >
      {sortedEvents.map((event) => {
          if (!event) return null

          return (
            <li class="event-item">
              <EventCard event={event} language={currentLanguage} />
            </li>
          )
        })}
    </ul>
  </div>
  <ScrollNavigation size="medium" ariaLabel={currentLanguage === 'no' ? 'Bla gjennom arrangementer' : 'Scroll through events'} />
</section>

<style>
  /* Scroll Container */
  .event-scroll-container {
    container-type: inline-size;
    width: min(100ch, 100% - 4rem);
    margin-inline: auto;
    margin-block: var(--space-m-l); /* Fluid 16px â†’ 30px */
  }

  .event-scroll-title {
    font-size: var(--step-3);
    font-weight: 600;
    margin-block-end: var(--space-m);
  }

  /* Scroll list - behavior from scroll-containers.css */
  .event-list {
    list-style: none;
    margin: 0;
    padding-block: var(--space-2);
  }

  .event-item {
    /* Container for EventCard component */
    display: contents;
  }

  /* Hide scrollbar on touch devices only (mouse users need scrollbar) */
  @media (pointer: coarse) {
    .hide-scrollbar .event-list.scroll-container {
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding-block-end: 0;
    }

    .hide-scrollbar .event-list.scroll-container::-webkit-scrollbar {
      display: none;
    }
  }

  /* Support for reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .event-list.scroll-container {
      scroll-behavior: auto;
    }
  }
</style>
