---
/**
 * EventCard - Compact event display for program listings
 *
 * Displays event summary with title, excerpt, image, date/venue, and ticket status.
 * Used in program page listings and filtered results. Links to full event page.
 *
 * Ticket status rendering:
 * - 'info' type: Shows custom badge (e.g., "Gratis")
 * - 'sold_out': Disabled button
 * - 'low_stock': Warning-styled buy button
 * - default: Primary buy button
 *
 * @see src/lib/sanity/queries.ts - EventResult type
 */

import { formatDateWithWeekday } from '../lib/utils/dates';
import { IMAGE_QUALITY, getOptimizedImageUrl, getResponsiveImageSet } from '../lib/sanityImage';
import { stegaClean } from '@sanity/client/stega';
import type { EventResult } from '../lib/sanity/queries';
import TicketButton from './TicketButton.astro';

export interface Props {
  /** Event data from Sanity */
  event: EventResult;
  /** Display language for labels and date formatting */
  language?: 'no' | 'en';
}

const { event, language = 'no' } = Astro.props;

// Determine event link based on language
const eventSlug = language === 'en'
  ? stegaClean(event.slug_en?.current || event.slug_no?.current)
  : stegaClean(event.slug_no?.current || event.slug_en?.current);

const eventPath = language === 'en' ? `/en/program/${eventSlug}` : `/program/${eventSlug}`;

// Translation strings
const dateLabel = language === 'en' ? 'Date and time' : 'Dato og tid';
const venueLabel = language === 'en' ? 'Venue' : 'Sted';
---

<article class="event-card card" data-event-date={event.eventDate?.date}>
  <hgroup>
    <h3 class="event-title">
      <a href={eventPath} class="event-title-link card-link">
        {stegaClean(event.title)}
      </a>
    </h3>

    {event.excerpt && (
      <p class="event-excerpt">{stegaClean(event.excerpt)}</p>
    )}
  </hgroup>

  {event.image?.image && (
    <div class="event-image">
      <img
        src={getOptimizedImageUrl(event.image.image, 320, 180, IMAGE_QUALITY.CARD)}
        srcset={getResponsiveImageSet(event.image.image, [320, 640, 960], 16/9, IMAGE_QUALITY.CARD)}
        sizes="320px"
        alt={stegaClean(event.image.alt || event.title || '')}
        width="320"
        height="180"
        loading="lazy"
        decoding="async"
        class="event-card-image"
      />
    </div>
  )}

  <dl class="event-meta">
    {event.eventDate?.date && (
      <>
        <dt class="visually-hidden">{dateLabel}</dt>
        <dd class="event-datetime">
          <time datetime={event.eventDate.date}>
            {formatDateWithWeekday(event.eventDate.date, language)}{event.eventTime && (
              <>, kl. {stegaClean(event.eventTime.startTime)}</>
            )}
          </time>
        </dd>
      </>
    )}
    {event.venue?.title && (
      <>
        <dt class="visually-hidden">{venueLabel}</dt>
        <dd class="event-venue">
          {stegaClean(event.venue.title)}
        </dd>
      </>
    )}
  </dl>

  <TicketButton
    ticketType={event.ticketType}
    ticketStatus={event.ticketStatus}
    ticketUrl={event.ticketUrl}
    ticketInfoText={event.ticketInfoText}
    eventTitle={event.title}
    language={language}
  />
</article>
