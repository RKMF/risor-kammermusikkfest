---
import Image from './Image.astro';
import { formatDateWithWeekday } from '../lib/utils/dates';
import { IMAGE_QUALITY } from '../lib/sanityImage';
import { stegaClean } from '@sanity/client/stega';
import type { EventResult } from '../lib/sanity/queries';

export interface Props {
  event: EventResult;
  language?: 'no' | 'en';
}

const { event, language = 'no' } = Astro.props;

// Determine event link based on language
const eventSlug = language === 'en'
  ? stegaClean(event.slug_en?.current || event.slug_no?.current)
  : stegaClean(event.slug_no?.current || event.slug_en?.current);

const eventPath = language === 'en' ? `/en/program/${eventSlug}` : `/program/${eventSlug}`;

// Translation strings
const dateLabel = language === 'en' ? 'Date and time' : 'Dato og tid';
const venueLabel = language === 'en' ? 'Venue' : 'Sted';
const ticketButtonText = language === 'en' ? 'Buy tickets here' : 'Kj√∏p billetter her';
const freeText = language === 'en' ? 'Free' : 'Gratis';
---

<article class="event-card card" data-event-date={event.eventDate?.date}>
  <h3 class="event-title">
    <a href={eventPath} class="event-title-link">
      {stegaClean(event.title)}
    </a>
  </h3>

  {event.excerpt && (
    <p class="event-excerpt">{stegaClean(event.excerpt)}</p>
  )}

  {event.image?.image && (
    <figure class="event-image" data-layout-context>
      <Image
        image={event.image.image}
        alt={stegaClean(event.image.alt || event.title || '')}
        size="medium"
        aspectRatio="3:2"
        loading="lazy"
        quality={IMAGE_QUALITY.CARD}
        className="event-card-image"
      />
    </figure>
  )}

  <dl class="event-meta">
    {event.eventDate?.date && (
      <>
        <dt class="visually-hidden">{dateLabel}</dt>
        <dd class="event-datetime">
          {formatDateWithWeekday(event.eventDate.date, language)}{event.eventTime && (
            <>, kl. {stegaClean(event.eventTime.startTime)}</>
          )}
        </dd>
      </>
    )}
    {event.venue?.title && (
      <>
        <dt class="visually-hidden">{venueLabel}</dt>
        <dd class="event-venue">
          {stegaClean(event.venue.title)}
        </dd>
      </>
    )}
  </dl>

  {stegaClean(event.ticketType) === 'info' ? (
    <span class="ticket-badge">{stegaClean(event.ticketInfoText) || freeText}</span>
  ) : (
    <a href={stegaClean(event.ticketUrl)} class="btn btn-primary" target="_blank" rel="noopener noreferrer">
      {ticketButtonText}
    </a>
  )}
</article>
