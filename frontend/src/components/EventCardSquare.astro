---
import { formatDateWithWeekday } from '../lib/utils/dates';
import { stegaClean } from '@sanity/client/stega';
import type { EventResult } from '../lib/sanity/queries';

export interface Props {
  event: EventResult;
  language?: 'no' | 'en';
}

const { event, language = 'no' } = Astro.props;

// Determine event link based on language
const eventSlug = language === 'en'
  ? stegaClean(event.slug_en?.current || event.slug_no?.current)
  : stegaClean(event.slug_no?.current || event.slug_en?.current);

const eventPath = language === 'en' ? `/en/program/${eventSlug}` : `/program/${eventSlug}`;

// Translation strings
const dateLabel = language === 'en' ? 'Date and time' : 'Dato og tid';
const venueLabel = language === 'en' ? 'Venue' : 'Sted';
const ticketButtonText = language === 'en' ? 'Buy tickets' : 'Kj√∏p billetter';
const freeText = language === 'en' ? 'Free' : 'Gratis';
---

<article class="event-card-square">
  <h3 class="event-card-square-title">
    <a href={eventPath} class="stretched-link">
      {stegaClean(event.title)}
    </a>
  </h3>

  <dl class="event-card-square-meta">
    {event.eventDate?.date && (
      <>
        <dt class="visually-hidden">{dateLabel}</dt>
        <dd class="event-card-square-datetime">
          <time datetime={event.eventDate.date}>
            {formatDateWithWeekday(event.eventDate.date, language)}{event.eventTime && (
              <>, kl. {stegaClean(event.eventTime.startTime)}</>
            )}
          </time>
        </dd>
      </>
    )}
    {event.venue?.title && (
      <>
        <dt class="visually-hidden">{venueLabel}</dt>
        <dd class="event-card-square-venue">
          {stegaClean(event.venue.title)}
        </dd>
      </>
    )}
  </dl>

  {stegaClean(event.ticketType) === 'info' && (
    <span class="event-card-square-ticket-info">{stegaClean(event.ticketInfoText) || freeText}</span>
  )}

  {stegaClean(event.ticketType) === 'button' && (
    <a
      href={stegaClean(event.ticketUrl)}
      class="btn btn-primary event-card-square-btn"
      target="_blank"
      rel="noopener noreferrer"
    >
      {ticketButtonText}
    </a>
  )}
</article>

<style>
  /* 1:1 Aspect Ratio Event Card */
  .event-card-square {
    position: relative;
    container-type: inline-size;
    display: grid;
    grid-template-rows: auto auto auto;

    overflow: hidden;
    background-color: var(--color-event-card-bg);
    border-radius: var(--radius-sm, 0);
    transition: transform 200ms cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 200ms cubic-bezier(0.4, 0, 0.2, 1),
                background-color 200ms cubic-bezier(0.4, 0, 0.2, 1);

    padding: var(--space-4);

    aspect-ratio: 1 / 1;
    width: 220px;

    min-height: 0;
    scroll-snap-align: start;
  }

  /* Base hover effect - lift card upward */
  @media (hover: hover) {
    .event-card-square:hover {
      transform: translateY(-4px);
      box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px;
      background-color: rgba(0, 179, 154, 0.08);
    }

    .event-card-square:hover .event-card-square-title a {
      color: var(--color-blue);
    }
  }

  /* Override hover effect for horizontal scroll mode to prevent clipping */
  @container (max-width: 800px) {
    @media (hover: hover) {
      .event-card-square:hover {
        transform: scale(1.02);
        box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px;
        background-color: rgba(0, 179, 154, 0.08);
      }
    }
  }

  .event-card-square-title {
    margin: 0;
    font-family: Georgia, 'Times New Roman', serif;
    font-size: clamp(var(--step-0), 0.75rem + 5cqi, var(--step-1));
    font-weight: var(--font-weight-semibold);
    line-height: 1.2;
    color: var(--color-event-card-text);

    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    overflow-wrap: break-word;
    word-wrap: break-word;
    hyphens: none;
  }

  @supports not (font-size: 1cqi) {
    .event-card-square-title {
      font-size: var(--step-1);
    }
  }

  .event-card-square-title a {
    color: inherit;
    text-decoration: none;
  }

  .event-card-square-meta {
    position: relative;
    z-index: 0;
    margin: 0;
    margin-top: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    font-size: var(--step--1);
    color: var(--color-event-card-text);
  }

  .event-card-square-datetime,
  .event-card-square-venue {
    margin: 0;
  }

  .event-card-square-ticket-info {
    font-size: var(--step--1);
    font-weight: var(--font-weight-semibold);
    color: var(--color-event-card-text);
    margin-top: 0.75rem;
    align-self: start;
  }

  .event-card-square-btn {
    white-space: nowrap;
    margin-top: 0.75rem;
    align-self: start;
    position: relative;
    z-index: 2;
    font-size: var(--step-0);
    padding: var(--space-3) var(--space-4);
  }

  /* Stretched link pattern for card clickability */
  .stretched-link::after {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 1;
    content: "";
  }

  /* Visually hidden label */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>
