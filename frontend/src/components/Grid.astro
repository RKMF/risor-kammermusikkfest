---
import DynamicComponent from './DynamicComponent.astro'

export interface Props {
  title?: string
  columns: '2' | '3'
  items: any[]
  aspectRatio?: '4:5' | '1:1'
  gap?: 'small' | 'medium' | 'large'
  className?: string
  _key?: string
  _type?: string
}

const {
  title,
  columns = '3',
  items = [],
  aspectRatio = '4:5',
  gap = 'medium',
  className = '',
  _key,
  _type,
} = Astro.props

// Map gap values to fluid spacing tokens
const gapMap = {
  small: 'var(--space-s-m)',      /* 12px → 20px fluid */
  medium: 'var(--space-l-xl)',    /* 24px → 40px fluid */
  large: 'var(--space-xl-2xl)',   /* 32px → 60px fluid */
}

const gapValue = gapMap[gap] || gapMap.medium

// Convert aspectRatio string to CSS value
const aspectMap: Record<string, string> = {
  '4:5': '4 / 5',
  '1:1': '1 / 1',
}
const aspectValue = aspectMap[aspectRatio] || '4 / 5'

// Calculate if we have an odd number of items for centering logic
const itemCount = items.length
const columnsNumber = parseInt(columns)
const isOdd = itemCount % columnsNumber !== 0

// Sanity Visual Editing attributes
const sanityAttributes = _key ? { 'data-sanity': `${_type}.${_key}` } : {}
---

<section class={`grid-component content-wide ${className}`} {...sanityAttributes}>
  {title && <h2 class="grid-title">{title}</h2>}

  <div
    class={`grid-container ${isOdd ? 'has-odd-items' : ''}`}
    data-columns={columns}
    data-layout-context="grid"
    style={`--grid-gap: ${gapValue}; --grid-aspect-ratio: ${aspectValue};`}
  >
    {items.map((item, index) => (
      <div class={`grid-item ${isOdd && index >= itemCount - (itemCount % columnsNumber) ? 'bottom-row' : ''}`}>
        <DynamicComponent block={item} />
      </div>
    ))}
  </div>
</section>

<style>
  .grid-component {
    margin-block: var(--space-xl-2xl); /* Fluid 32px → 60px section spacing */
    max-width: 100%;
  }

  .grid-title {
    font-size: var(--fs-2xl);
    font-weight: 600;
    margin-block-end: var(--space-l-xl); /* Fluid 24px → 40px */
  }

  .grid-container {
    display: grid;
    gap: var(--grid-gap, var(--space-l-xl)); /* Default fluid gap: 24px → 40px */
    width: 100%;
    align-items: stretch;

    /* Container query context - allows children to adapt to available space */
    container-type: inline-size;
    container-name: grid-layout;

    /* Intrinsic grid - columns adapt to available space automatically */
    grid-template-columns: repeat(
      auto-fit,
      minmax(min(var(--grid-min-width), 100%), 1fr)
    );

    /* Default minimum width for grid items */
    --grid-min-width: 250px;
  }

  /* Control minimum item width via data attribute */
  /* 2-column grid: larger minimum = max 2 columns */
  .grid-container[data-columns='2'] {
    --grid-min-width: 45%;
  }

  /* 3-column grid: smaller minimum = allows up to 3 columns */
  .grid-container[data-columns='3'] {
    --grid-min-width: 280px;
  }

  /* All grid items use configurable aspect ratio */
  .grid-item {
    width: 100%;
    aspect-ratio: var(--grid-aspect-ratio, 4 / 5);
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
    min-height: 300px; /* Prevent tiny boxes */

    /* Performance optimizations */
    contain: layout style paint;
    content-visibility: auto;
  }

  /* Centering logic for odd number of items */
  /* When we have odd items, the bottom row should be centered and not enlarged */
  .grid-container.has-odd-items {
    justify-items: center;
  }

  /* Bottom row items maintain their size, don't stretch */
  .grid-container.has-odd-items .grid-item.bottom-row {
    max-width: 100%;
  }

  /* Media content: Fill and crop */
  .grid-item > :global(.image-container),
  .grid-item > :global([data-component="video"]) {
    width: 100%;
    height: 100%;
    flex: 1;
  }

  .grid-item > :global(.image-container .image),
  .grid-item > :global(.image) {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Components that fill grid space and respect aspect ratio */
  .grid-item > :global([data-component="quote"]),
  .grid-item > :global([data-component="video"]) {
    width: 100%;
    height: 100%;
    flex: 1;
  }

  /* Quote component: Scrollable within fixed height */
  .grid-item > :global([data-component="quote"]) {
    overflow-y: auto;
    height: 100%;
    padding: var(--space-m-l); /* Fluid 16px → 30px */

    /* Custom scrollbar styling */
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
  }

  .grid-item > :global([data-component="quote"])::-webkit-scrollbar {
    width: 8px;
  }

  .grid-item > :global([data-component="quote"])::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
  }

  /* Container query: Adjust gap in narrow containers */
  @container grid-layout (max-width: 600px) {
    .grid-container {
      gap: var(--space-m-l); /* Slightly smaller gap when narrow */
    }
  }

  /* Note: No viewport media queries needed! Grid automatically adapts to container size */
  /* Columns reflow based on available space using intrinsic auto-fit pattern */

  /* Accessibility */
  .grid-item:focus-within {
    outline: 2px solid #0066cc;
    outline-offset: 2px;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .grid-item {
      transition: none;
    }
  }

  /* Print styles */
  @media print {
    .grid-container {
      display: block;
    }

    .grid-item {
      page-break-inside: avoid;
      margin-block-end: var(--space-m);
      aspect-ratio: auto;
      overflow: visible;
      contain: none;
      min-height: auto;
    }

    .grid-item > :global([data-component="quote"]) {
      overflow-y: visible;
      height: auto;
    }
  }
</style>
