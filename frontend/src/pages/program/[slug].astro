---
import Layout from '../../layouts/Layout.astro';
import DynamicComponent from '../../components/DynamicComponent.astro';
import Image from '../../components/Image.astro';
import { formatDateWithWeekday } from '../../lib/utils/dates';
import { getMultilingualContent } from "../../lib/utils/language.js";
import { IMAGE_QUALITY, getOptimizedImageUrl, getResponsiveImageSet } from '../../lib/sanityImage';
import { createDataService } from '../../lib/sanity/dataService.js';
import { stegaClean } from '@sanity/client/stega';
import '../../styles/event.css';

// Generate static paths for all events
export async function getStaticPaths() {
  const dataService = createDataService();
  const events = await dataService.getSlugsForType('event');

  return events.map((event: any) => ({
    params: event.params
  }));
}

const { params } = Astro;

// Fetch event using DataService with language awareness
const dataService = createDataService(Astro.request);
const event = await dataService.getEventBySlug(params.slug);

if (!event) {
  return Astro.redirect('/404');
}

// Get appropriate content arrays
const description = getMultilingualContent(event, 'no', 'description') || event.description_no;
const extraContent = getMultilingualContent(event, 'no', 'extraContent') || event.extraContent_no;
---

<Layout
  title={`${stegaClean(event.title || '')} - Sanity + Astro`}
  slugNo={event.slug_no?.current}
  slugEn={event.slug_en?.current}
>
  <div class="container">
    <div class="event-page">
      <header class="event-header">
        <h1 class="event-title">{stegaClean(event.title || '')}</h1>
        {event.excerpt && (
          <p class="event-excerpt">{stegaClean(event.excerpt)}</p>
        )}
      </header>

      <div class="event-meta">
        {event.eventDate?.date && (
          <div class="event-meta-item">{stegaClean(formatDateWithWeekday(event.eventDate.date, 'no'))}</div>
        )}
        {event.eventTime && (
          <div class="event-meta-item">kl. {stegaClean(event.eventTime.startTime)}–{stegaClean(event.eventTime.endTime)}</div>
        )}
        {event.venue?.title && (
          <div class="event-meta-item">{stegaClean(event.venue.title)}</div>
        )}
      </div>

      <div class="ticket-section">
        {stegaClean(event.ticketType) === 'info' ? (
          <p class="ticket-info">{stegaClean(event.ticketInfoText) || 'Gratis'}</p>
        ) : (
          <a href={stegaClean(event.ticketUrl)} class="btn btn-primary" target="_blank" rel="noopener noreferrer">
            Kjøp billetter her
          </a>
        )}
      </div>

      {description && (
        <section class="event-description content-narrow">
          <h2 class="section-title">Om konserten</h2>
          <p class="description-text">{stegaClean(description)}</p>
        </section>
      )}

      {event.artists && event.artists.length > 0 && (
        <section class="artists-section">
          <h2 class="artists-title">Artister</h2>
          <div class="artist-section scroll-container scroll-container--artist-cards scroll-container--styled-scrollbar">
            {event.artists.map((artist) => (
              <article class="artist-card artist-card--medium">
                <h3 class="artist-title">
                  <a href={`/artister/${stegaClean(artist.slug)}`} class="artist-title-link">
                    {stegaClean(artist.name)}
                  </a>
                </h3>

                {artist.image?.image && (
                  <img
                    src={getOptimizedImageUrl(artist.image.image, 320, 400, IMAGE_QUALITY.CARD)}
                    srcset={getResponsiveImageSet(artist.image.image, [320, 480, 640], 4/5, IMAGE_QUALITY.CARD)}
                    sizes="320px"
                    alt={stegaClean(artist.image.alt) || stegaClean(artist.name)}
                    width="320"
                    height="400"
                    loading="lazy"
                    decoding="async"
                    class="artist-card-image"
                  />
                )}

                <div class="artist-info-box">
                  <p class="artist-name">{stegaClean(artist.name)}</p>
                  {artist.instrument && (
                    <p class="artist-instrument">{stegaClean(artist.instrument)}</p>
                  )}
                </div>
              </article>
            ))}
          </div>
        </section>
      )}

      {extraContent && Array.isArray(extraContent) && extraContent.length > 0 && (
        <div class="event-extra-content">
          {extraContent.map((block) => (
            <DynamicComponent key={block._key || block._id} block={block} />
          ))}
        </div>
      )}

      {event.image?.image?.asset && (
        <Image
          image={event.image.image}
          alt={stegaClean(event.image.alt || event.title || '')}
          credit={event.image.credit ? stegaClean(event.image.credit) : undefined}
          size="large"
          aspectRatio="4:3"
          loading="lazy"
          quality={IMAGE_QUALITY.CARD}
          className="event-image-bottom"
        />
      )}
    </div>
  </div>
</Layout>

