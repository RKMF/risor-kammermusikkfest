---
import Layout from '../../layouts/Layout.astro';
import DynamicComponent from '../../components/DynamicComponent.astro';
import Image from '../../components/Image.astro';
import { formatDateWithWeekday } from '../../lib/utils/dates';
import { getMultilingualContent } from "../../lib/utils/language.js";
import { IMAGE_QUALITY } from '../../lib/sanityImage';
import type { SanityDocument } from '@sanity/client';
import { loadQuery } from '../../lib/sanity/loadQuery.js';
import { stegaClean } from '@sanity/client/stega';
import '../../styles/event.css';

// Generate static paths for all events
export async function getStaticPaths() {
  const { data: events } = await loadQuery<SanityDocument[]>({
    query: `*[_type == "event" && (defined(slug_no.current) || defined(slug_en.current))]`,
  });

  return events.map((event) => {
    // Use Norwegian slug, fallback to English slug
    const slug = event.slug_no?.current || event.slug_en?.current;
    return {
      params: { slug },
    };
  });
}

const { params } = Astro;

// Fetch the specific event based on the slug parameter (Norwegian priority)
const { data: event } = await loadQuery({
  query: `*[_type == "event" && $slug in [slug_no.current, slug_en.current, slug.current]][0]{
    _id,
    _type,
    title_no,
    "title": title_no,
    slug_no,
    excerpt_no,
    "excerpt": excerpt_no,
    description_no,
    "description": description_no,
    "image": {
      "image": image{
        asset->,
        hotspot,
        crop
      },
      "alt": coalesce(imageAlt_no, imageAlt_en, image.alt),
      "credit": coalesce(imageCredit_no, imageCredit_en)
    },
    eventDate->{
      _id,
      date,
      title_display_no,
      "title": title_display_no
    },
    eventTime,
    venue->{
      _id,
      title,
      name,
      address,
      city,
      "slug": slug.current
    },
    "artists": artist[]-> {
      _id,
      name,
      "slug": slug.current,
      "image": {
        "image": image{
          asset->{
            _id,
            url,
            metadata {
              dimensions {
                width,
                height,
                aspectRatio
              },
              lqip
            }
          },
          hotspot,
          crop
        },
        "alt": coalesce(imageAlt_no, imageAlt_en, image.alt)
      },
      instrument_no,
      "instrument": instrument_no,
      country
    },
    ticketType,
    ticketUrl,
    ticketInfoText,
    extraContent_no,
    extraContent_en,
    seo
  }`,
  params,
});

if (!event) {
  return Astro.redirect('/404');
}

// Get appropriate content arrays
const description = getMultilingualContent(event, 'no', 'description') || event.description_no;
const extraContent = getMultilingualContent(event, 'no', 'extraContent') || event.extraContent_no;
---

<Layout
  title={`${stegaClean(event.title || '')} - Sanity + Astro`}
  slugNo={event.slug_no}
  slugEn={event.slug_en}
>
  <div class="container">
    <div class="event-page">
      <header class="event-header">
        <h1 class="event-title">{stegaClean(event.title || '')}</h1>
        {event.excerpt && (
          <p class="event-excerpt">{stegaClean(event.excerpt)}</p>
        )}
      </header>

      <div class="event-meta">
        {event.eventDate?.date && (
          <div class="event-meta-item">{stegaClean(formatDateWithWeekday(event.eventDate.date, 'no'))}</div>
        )}
        {event.eventTime && (
          <div class="event-meta-item">kl. {stegaClean(event.eventTime.startTime)}–{stegaClean(event.eventTime.endTime)}</div>
        )}
        {event.venue?.title && (
          <div class="event-meta-item">{stegaClean(event.venue.title)}</div>
        )}
      </div>

      <div class="ticket-section">
        {stegaClean(event.ticketType) === 'info' ? (
          <p class="ticket-info">{stegaClean(event.ticketInfoText) || 'Gratis'}</p>
        ) : (
          <a href={stegaClean(event.ticketUrl)} class="btn btn-primary" target="_blank" rel="noopener noreferrer">
            Kjøp billetter her
          </a>
        )}
      </div>

      {description && (
        <section class="event-description content-narrow">
          <h2 class="section-title">Om konserten</h2>
          <p class="description-text">{stegaClean(description)}</p>
        </section>
      )}

      {event.artists && event.artists.length > 0 && (
        <section class="artists-section">
          <h2 class="artists-title">Artister</h2>
          <div class="artists-scroll-wrapper">
            <ul class="artists-list">
              {event.artists.map((artist) => (
                <li class="artist-item">
                  <article class="artist-card">
                    <h3 class="artist-title">
                      <a href={`/artister/${stegaClean(artist.slug)}`} class="artist-title-link">
                        {stegaClean(artist.name)}
                      </a>
                    </h3>

                    {artist.image?.image?.asset && (
                      <Image
                        image={artist.image.image}
                        alt={stegaClean(artist.image.alt || artist.name || '')}
                        size="small"
                        aspectRatio="4:5"
                        loading="lazy"
                        quality={IMAGE_QUALITY.CARD}
                        className="artist-card-image"
                      />
                    )}

                    <div class="artist-info-box">
                      <p class="artist-name">{stegaClean(artist.name)}</p>
                      {artist.instrument && (
                        <p class="artist-instrument">{stegaClean(artist.instrument)}</p>
                      )}
                    </div>
                  </article>
                </li>
              ))}
            </ul>
          </div>
        </section>
      )}

      {extraContent && Array.isArray(extraContent) && extraContent.length > 0 && (
        <div class="event-extra-content">
          {extraContent.map((block) => (
            <DynamicComponent key={block._key || block._id} block={block} />
          ))}
        </div>
      )}

      {event.image?.image?.asset && (
        <Image
          image={event.image.image}
          alt={stegaClean(event.image.alt || event.title || '')}
          credit={event.image.credit ? stegaClean(event.image.credit) : undefined}
          size="large"
          aspectRatio="4:3"
          loading="lazy"
          quality={IMAGE_QUALITY.CARD}
          className="event-image-bottom"
        />
      )}
    </div>
  </div>
</Layout>

