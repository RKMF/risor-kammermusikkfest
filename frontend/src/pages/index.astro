---
import Layout from '../layouts/Layout.astro';
import DynamicComponent from '../components/DynamicComponent.astro';
import { createDataService } from '../lib/sanity/dataService.js';
import { getMultilingualContent, detectLanguage } from '../lib/utils/language.js';
import { stegaClean } from '@sanity/client/stega';
import tekstLogoSvg from '../assets/tekst-logo.svg?raw';

// Create data service with Visual Editing support
const dataService = createDataService(Astro.request);

// Load homepage using data service
const homepage = await dataService.getHomepage();

const homepageTitle = homepage?.title || 'Forside';

// Smart caching basert på innholdstype
if (homepage?.scheduledPeriod) {
  const timeUntilExpiry = new Date(homepage.scheduledPeriod.endDate).getTime() - Date.now();
  const cacheTime = Math.min(timeUntilExpiry / 1000, 300); // Maks 5 minutter

  Astro.response.headers.set('Cache-Control', `public, max-age=${cacheTime}`);
} else {
  Astro.response.headers.set('Cache-Control', 'public, max-age=3600'); // 1 time
}

// Detect language and get content
const language = detectLanguage(Astro.request);
const content = homepage ? (getMultilingualContent(homepage, language) || homepage?.content || []) : [];

// Extract slug information
const slugNo = homepage?.slug_no?.current ? stegaClean(homepage.slug_no.current) : undefined;
const slugEn = homepage?.slug_en?.current ? stegaClean(homepage.slug_en.current) : undefined;

console.log('Aktiv forside:', homepage);
---

<Layout title={homepageTitle} slugNo={slugNo} slugEn={slugEn}>
  <div class="stack page-layout" style="--space: var(--space-xl)">
    {!homepage && (
      <div class="no-content">
        <h1>Velkommen til forsiden</h1>
        <p>Ingen forside er konfigurert ennå. Gå til Sanity Studio for å opprette en forside.</p>
      </div>
    )}

    {tekstLogoSvg && content && Array.isArray(content) && content.length > 0 && (
      <div class="homepage-grid">
        <!-- Logo on the left - FIRST in source order -->
        <div class="tekst-logo-container">
          <div
            class="tekst-logo"
            role="img"
            aria-label="Risør Kammermusikkfest"
            set:html={tekstLogoSvg}
          />
        </div>

        <!-- Blue box on the right - SECOND in source order -->
        <div class="homepage-content">
          {content.map((block) => (
            <DynamicComponent key={block._key || block._id} block={block} />
          ))}
        </div>
      </div>
    )}
  </div>
</Layout>

<style>
  .no-content {
    margin: 0;
  }

  /* Page layout styling */
  .page-layout {
    container-type: inline-size;
    container-name: page-layout;
    min-inline-size: min(100%, 280px);
  }

  .page-header {
    margin: 0;
    container-type: inline-size;
  }

  .page-title {
    margin: 0 0 var(--space-6) 0;
    font-size: var(--heading-h1);
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
  }

  /* Homepage grid layout - stacked on mobile */
  .homepage-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-m);
    align-items: start;
    margin-block: var(--space-l);
    background-color: var(--color-tint-blue-medium);
    padding: var(--space-l);
  }

  /* On desktop, logo and content side by side */
  @media (min-width: 769px) {
    .homepage-grid {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-l);
      align-items: center;
    }
  }

  .homepage-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-l);
  }

  .tekst-logo-container {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Static blue logo - fluid sizing */
  .tekst-logo {
    width: 100%;
    max-width: clamp(280px, 50vw, 400px);
    aspect-ratio: 4 / 5;
    color: #1B198F;
  }

  .tekst-logo :global(svg) {
    width: 100%;
    height: 100%;
    display: block;
  }

</style>
