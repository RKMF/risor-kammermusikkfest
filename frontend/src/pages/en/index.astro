---
import Layout from '../../layouts/Layout.astro';
import DynamicComponent from '../../components/DynamicComponent.astro';
import { createDataService } from '../../lib/sanity/dataService.js';
import { getMultilingualContent, detectLanguage } from '../../lib/utils/language.js';
import { stegaClean } from '@sanity/client/stega';
import tekstLogoSvg from '../../assets/tekst-logo.svg?raw';

// Create data service with Visual Editing support
const dataService = createDataService(Astro.request);

// Load homepage using data service
const homepage = await dataService.getHomepage();

const homepageTitle = homepage?.title || 'Home';

// Smart caching based on content type
if (homepage?.scheduledPeriod) {
  const timeUntilExpiry = new Date(homepage.scheduledPeriod.endDate).getTime() - Date.now();
  const cacheTime = Math.min(timeUntilExpiry / 1000, 300); // Max 5 minutes

  Astro.response.headers.set('Cache-Control', `public, max-age=${cacheTime}`);
} else {
  Astro.response.headers.set('Cache-Control', 'public, max-age=3600'); // 1 hour
}

// Detect language and get content
const language = detectLanguage(Astro.request);
const content = homepage ? (getMultilingualContent(homepage, language) || homepage?.content || []) : [];

// Extract header links (separate from pageBuilder content)
const headerLinks = homepage?.headerLinks_en || [];
const hasHeaderLinks = headerLinks.length > 0;

// Helper to resolve internal link URLs
function resolveInternalLinkUrl(link: any): string {
  if (link.linkType === 'external' && link.url) {
    return link.url;
  }
  if (link.linkType === 'internal' && link.internalLink) {
    const ref = link.internalLink;
    const slug = language === 'en'
      ? (ref.slug_en || ref.slug_no || ref.slug)
      : (ref.slug_no || ref.slug_en || ref.slug);

    // Build URL based on document type (English URLs)
    const prefix = '/en';
    switch (ref._type) {
      case 'programPage':
        return `${prefix}/program`;
      case 'artistPage':
        return `${prefix}/artists`;
      case 'articlePage':
        return `${prefix}/articles`;
      case 'event':
        return `${prefix}/program/${slug}`;
      case 'artist':
        return `${prefix}/artists/${slug}`;
      case 'article':
        return `${prefix}/articles/${slug}`;
      case 'page':
        return `${prefix}/${slug}`;
      default:
        return slug ? `${prefix}/${slug}` : prefix;
    }
  }
  return '/en';
}

// Extract slug information
const slugNo = homepage?.slug_no?.current ? stegaClean(homepage.slug_no.current) : undefined;
const slugEn = homepage?.slug_en?.current ? stegaClean(homepage.slug_en.current) : undefined;

console.log('Active homepage:', homepage);
---

<Layout title={homepageTitle} slugNo={slugNo} slugEn={slugEn} frontpage>
  <div class="stack page-layout" style="--space: var(--space-xl)">
    {!homepage && (
      <div class="no-content">
        <h1>Welcome to the homepage</h1>
        <p>No homepage is configured yet. Go to Sanity Studio to create a homepage.</p>
      </div>
    )}

    {/* Hero section - logo always shown, links conditional */}
    {tekstLogoSvg && (
      <div class={`homepage-hero ${hasHeaderLinks ? 'homepage-hero--with-links' : ''}`}>
        <div class="tekst-logo-container">
          <div
            class="tekst-logo"
            role="img"
            aria-label="Risor Chamber Music Festival"
            set:html={tekstLogoSvg}
          />
        </div>

        {hasHeaderLinks && (
          <nav class="header-links" aria-label="Main links">
            {headerLinks.map((link) => (
              <div class="header-link-item">
                <a
                  href={resolveInternalLinkUrl(link)}
                  class="header-link"
                >
                  <span class="header-link__text">{link.text}</span>
                </a>
                {link.description && (
                  <p class="header-link__description">{link.description}</p>
                )}
              </div>
            ))}
          </nav>
        )}
      </div>
    )}

    {/* PageBuilder content - rendered below hero */}
    {content && Array.isArray(content) && content.length > 0 && (
      <div class="homepage-content">
        {content.map((block) => (
          <DynamicComponent key={block._key || block._id} block={block} />
        ))}
      </div>
    )}
  </div>
</Layout>

<style>
  .no-content {
    margin: 0;
  }

  /* Page layout styling */
  .page-layout {
    container-type: inline-size;
    container-name: page-layout;
    min-inline-size: min(100%, 280px);
  }

  /* Hero section - blue box with logo and CTA links */
  .homepage-hero {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-m);
    align-items: start;
    margin-block: var(--space-l);
    background-color: var(--color-tint-blue-medium);
    padding: var(--space-l);
  }

  /* On desktop with links, logo and links side by side */
  @media (min-width: 769px) {
    .homepage-hero--with-links {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-l);
      align-items: center;
    }
  }

  .tekst-logo-container {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Static blue logo - fluid sizing */
  .tekst-logo {
    width: 100%;
    max-width: clamp(280px, 50vw, 400px);
    aspect-ratio: 4 / 5;
    color: #1B198F;
  }

  .tekst-logo :global(svg) {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Header links - matching Link.astro styling */
  .header-links {
    display: flex;
    flex-direction: column;
    gap: var(--space-s-m);
    padding-inline-start: var(--space-s);
  }

  .header-link-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xs);
  }

  .header-link {
    display: inline-flex;
    align-items: center;
    padding: var(--space-2xs) var(--space-xs);
    font-weight: var(--font-weight-medium);
    font-size: var(--step-3);
    text-decoration: none;
    background-image: none;
  }

  .header-link::after {
    content: ' â†’';
    margin-inline-start: 0.25em;
  }

  .header-link__text {
    position: relative;
  }

  .header-link__text::after {
    content: '';
    position: absolute;
    inset-inline-start: 0;
    inset-block-end: 0;
    inline-size: 100%;
    block-size: 0.08em;
    background-color: currentColor;
    transform: scaleX(0);
    transform-origin: right;
    transition: transform var(--transition-fast);
  }

  @media (hover: hover) {
    .header-link:hover .header-link__text::after {
      transform: scaleX(1);
      transform-origin: left;
    }
  }

  .header-link:focus-visible .header-link__text::after {
    transform: scaleX(1);
    transform-origin: left;
  }

  .header-link:focus-visible {
    background-color: var(--color-tint-blue-light);
  }

  .header-link__description {
    margin: 0;
    font-size: var(--step-0);
    color: var(--color-text-secondary);
    line-height: 1.5;
    padding-inline-start: calc(var(--space-xs) + var(--space-s));
  }

  /* PageBuilder content below hero */
  .homepage-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-l);
  }
</style>
