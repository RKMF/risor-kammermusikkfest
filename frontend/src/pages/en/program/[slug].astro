---
import Layout from '../../../layouts/Layout.astro';
import DynamicComponent from '../../../components/DynamicComponent.astro';
import Image from '../../../components/Image.astro';
import { formatDateForLanguage } from '../../../lib/utils/dates';
import { getMultilingualContent } from "../../../lib/utils/language.js";
import { IMAGE_QUALITY } from '../../../lib/sanityImage';
import { createDataService } from '../../../lib/sanity/dataService.js';
import { stegaClean } from '@sanity/client/stega';
import '../../../styles/event.css';

// Generate static paths for all events
export async function getStaticPaths() {
  const dataService = createDataService();
  const events = await dataService.getSlugsForType('event');

  return events.map((event: any) => ({
    params: event.params
  }));
}

const { params } = Astro;

// Fetch event using DataService with language awareness
const dataService = createDataService(Astro.request);
const event = await dataService.getEventBySlug(params.slug);

if (!event) {
  return Astro.redirect('/404');
}

// Get English content
const content = getMultilingualContent(event, 'en') || event.content_en;
---

<Layout
  title={`${stegaClean(event.title || '')} - Sanity + Astro`}
  slugNo={event.slug_no?.current}
  slugEn={event.slug_en?.current}
>
  <div class="container">
    <div class="event-page">
      <div class="event-info-grid">
        <div class="event-info-column">
          <header class="event-header">
            <h1 class="event-title">{stegaClean(event.title || '')}</h1>
            {event.excerpt && (
              <p class="event-excerpt">{stegaClean(event.excerpt)}</p>
            )}
          </header>

          <div class="event-meta">
            {event.eventDate?.date && (
              <div class="event-meta-item">{stegaClean(formatDateForLanguage(event.eventDate.date, 'en'))}</div>
            )}
            {event.eventTime && (
              <div class="event-meta-item">{stegaClean(event.eventTime.startTime)}â€“{stegaClean(event.eventTime.endTime)}</div>
            )}
            {event.venue?.title && (
              <div class="event-meta-item">{stegaClean(event.venue.title)}</div>
            )}
          </div>

          <div class="ticket-section">
            {stegaClean(event.ticketType) === 'info' ? (
              <p class="ticket-info">{stegaClean(event.ticketInfoText) || 'Free'}</p>
            ) : (
              <a href={stegaClean(event.ticketUrl)} class="btn btn-primary" target="_blank" rel="noopener noreferrer">
                Buy tickets
              </a>
            )}
          </div>
        </div>

        {event.image?.image && (
          <div class="event-image-column">
            <figure class="event-image">
              <Image
                image={event.image.image}
                alt={stegaClean(event.image.alt || event.title || '')}
                size="medium"
                aspectRatio="4:3"
                loading="eager"
                quality={IMAGE_QUALITY.HERO}
                priority={true}
              />
            </figure>
          </div>
        )}
      </div>

      {event.artists && event.artists.length > 0 && (
        <section class="artists-section">
          <h2 class="artists-title">Artists</h2>
          <div class="artists-scroll-wrapper">
            <ul class="artists-list">
              {event.artists.map((artist) => (
                <li class="artist-item">
                  <a href={`/en/artists/${stegaClean(artist.slug)}`} class="artist-card">
                    <span class="artist-name">{stegaClean(artist.name)}</span>
                    {artist.instrument && (
                      <span class="artist-instrument">{stegaClean(artist.instrument)}</span>
                    )}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </section>
      )}

      {content && Array.isArray(content) && content.length > 0 && (
        <div class="event-content">
          {content.map((block) => (
            <DynamicComponent key={block._key || block._id} block={block} />
          ))}
        </div>
      )}
    </div>
  </div>
</Layout>
