---
import Layout from "../../../layouts/Layout.astro";
import DynamicComponent from "../../../components/DynamicComponent.astro";
import Image from "../../../components/Image.astro";
import EventCard from "../../../components/EventCard.astro";
import { getMultilingualContent } from "../../../lib/utils/language.js";
import { IMAGE_QUALITY } from '../../../lib/sanityImage';
import type { SanityDocument } from '@sanity/client';
import { loadQuery } from '../../../lib/sanity/loadQuery.js';
import { stegaClean } from '@sanity/client/stega';
import '../../../styles/event.css';
import '../../../styles/event-card.css';

// Generate static paths for all artists
export async function getStaticPaths() {
  const { data: artists } = await loadQuery<SanityDocument[]>({
    query: `*[_type == "artist" && defined(slug.current)]`,
  });

  return artists.map((artist) => {
    return {
      params: {
        slug: artist.slug.current,
      },
    };
  });
}

const { params } = Astro;

// Fetch the specific artist based on the slug parameter
const { data: artist } = await loadQuery({
  query: `*[_type == "artist" && slug.current == $slug][0]{
    _id,
    _type,
    name,
    excerpt_no,
    excerpt_en,
    instrument_no,
    instrument_en,
    "instrument": coalesce(instrument_en, instrument_no),
    "image": {
      "image": image{
        asset->,
        hotspot,
        crop
      },
      "alt": coalesce(imageAlt_en, imageAlt_no, image.alt),
      "credit": coalesce(imageCredit_en, imageCredit_no)
    },
    "slug": slug.current,
    content_no,
    content_en,
    instagram,
    facebook,
    spotify,
    youtube,
    websiteUrl,
    spotifyUrl,
    instagramUrl,
    seo,
    "events": *[_type == "event" && references(^._id) && publishingStatus == "published"] | order(eventDate->date asc, eventTime.startTime asc){
      _id,
      _type,
      title_no,
      title_en,
      "title": coalesce(title_en, title_no),
      slug_no,
      slug_en,
      excerpt_no,
      excerpt_en,
      "excerpt": coalesce(excerpt_en, excerpt_no),
      "image": {
        "image": image{
          asset->,
          hotspot,
          crop
        },
        "alt": coalesce(imageAlt_en, imageAlt_no, image.alt),
        "credit": coalesce(imageCredit_en, imageCredit_no)
      },
      eventDate->{
        _id,
        date,
        title_display_no,
        title_display_en,
        "title": coalesce(title_display_en, title_display_no)
      },
      eventTime,
      venue->{
        _id,
        title,
        name,
        address,
        city,
        "slug": slug.current
      },
      ticketType,
      ticketUrl,
      ticketInfoText,
      ticketStatus
    }
  }`,
  params,
});

if (!artist) {
  return Astro.redirect('/404');
}

// Get English content
const content = getMultilingualContent(artist, 'en') || artist.content_en;
---

<Layout title={`${artist.name} - Artist`}>
  <!-- Artist Card - Centered, same design as list cards -->
  <article class="artist-detail-card">
    <!-- Hidden SVG for wave clip-path definition -->
    <svg width="0" height="0" style="position: absolute;" aria-hidden="true">
      <defs>
        {/* Medium cards - top shallow wave pattern from logo (line 7) */}
        <clipPath id="artist-wave-clip-medium" clipPathUnits="objectBoundingBox">
          <path d="M 0 0.015 C 0.035 0.006, 0.077 0, 0.136 0 C 0.234 0, 0.286 0.01, 0.333 0.022 C 0.377 0.033, 0.415 0.048, 0.499 0.048 C 0.583 0.048, 0.621 0.033, 0.665 0.022 C 0.712 0.01, 0.764 0, 0.862 0 C 0.921 0, 0.963 0.006, 0.998 0.015 L 1 0.015 L 1 1 L 0 1 Z" />
        </clipPath>
      </defs>
    </svg>

    {artist.image?.image && (
      <Image
        image={artist.image.image}
        alt={stegaClean(artist.image.alt || artist.name)}
        credit={artist.image.credit ? stegaClean(artist.image.credit) : undefined}
        aspectRatio="4:5"
        loading="eager"
        quality={IMAGE_QUALITY.HERO}
        priority={true}
        className="artist-detail-card-image"
      />
    )}

    <div class="artist-detail-info-box">
      <h1 class="artist-name">{stegaClean(artist.name)}</h1>
      {artist.instrument && (
        <p class="artist-instrument">{stegaClean(artist.instrument)}</p>
      )}
    </div>
  </article>

  <!-- Excerpt -->
  {artist.excerpt_en && (
    <p class="excerpt">{stegaClean(artist.excerpt_en)}</p>
  )}

  <!-- Events Section -->
  {artist.events && artist.events.length > 0 && (
    <section class="artist-events">
      <h2 class="artist-events-title">Concerts</h2>
      <div class="artist-events-row">
        {artist.events.map((event) => (
          <EventCard event={event} language="en" />
        ))}
      </div>
    </section>
  )}

  <!-- Content below card -->
  {content && Array.isArray(content) && content.length > 0 && (
    <article class="artist-content">
      {content.map((block) => (
        <DynamicComponent key={block._key || block._id} block={block} />
      ))}
    </article>
  )}
</Layout>

<style>
  /* Artist Detail Card - Medium centered card (480px) with Grid stacking */
  .artist-detail-card {
    /* Grid layout for stacking image and info box */
    display: grid;
    grid-template: "content" 1fr / 1fr;

    aspect-ratio: 4 / 5;
    width: 480px;
    min-width: 480px;
    max-width: 480px;
    margin-inline: auto;
    margin-block-end: var(--space-6);
    background-color: rgba(27, 25, 143, 0.12); /* Light blue tint - matches listing page cards */
    overflow: hidden; /* Clip content to card bounds */
  }

  /* Artist Image - Grid positioned, inset from top and left */
  .artist-detail-card :global(.artist-detail-card-image) {
    grid-area: content;
    justify-self: start;
    align-self: start;
    margin-block-start: 1.5rem;
    margin-inline-start: 1.5rem;
    margin-inline-end: 0; /* Override Image.astro defaults */
    margin-block-end: 0; /* Override Image.astro defaults */
    width: 85%;
    height: auto;
    aspect-ratio: 4/5;
    overflow: hidden;
  }

  :global(.artist-detail-card-image .image) {
    width: 100%;
    height: auto;
    aspect-ratio: 4/5;

    /* Apply medium wave clip-path - top shallow wave pattern from logo */
    clip-path: url(#artist-wave-clip-medium);
  }

  /* Artist Info Box - Grid positioned in bottom right */
  .artist-detail-info-box {
    grid-area: content;
    justify-self: end;
    align-self: end;
    margin: 1.5rem;
    background-color: var(--color-blue-600);
    color: white;
    padding: 1.5rem;
    display: grid;
    gap: 0.375rem;
    z-index: 2;
    width: auto;
    min-width: 12ch;
    max-width: 85%;
  }

  .artist-detail-info-box .artist-name {
    margin: 0;
    font-family: Georgia, 'Times New Roman', serif;
    font-size: var(--step-3);
    line-height: 1.3;
    font-weight: 600;
    color: white;
    letter-spacing: 0.015em;
  }

  .artist-detail-info-box .artist-instrument {
    margin: 0;
    font-size: var(--step-0);
    line-height: 1.3;
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: white;
    opacity: 0.9;
  }

  /* Excerpt styling handled by global .excerpt class in base.css */

  /* Events section */
  .artist-events {
    max-width: 100%;
    width: 100%;
    margin-inline: auto;
    margin-block-start: var(--space-8);
    margin-block-end: var(--space-8);
    padding-inline: var(--space-4);
  }

  .artist-events-title {
    font-size: var(--step-3);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-block-start: 0;
    margin-block-end: var(--space-6);
    text-align: center;
  }

  .artist-events-row {
    /* Match program page grid-based scroll implementation */
    container-type: inline-size;
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: clamp(300px, 35vw, 320px); /* Match EventCard width */
    gap: var(--space-4);
    justify-content: start;

    /* Enable horizontal scroll */
    overflow-x: scroll;
    overflow-y: hidden;

    /* Smooth scrolling behavior */
    scroll-behavior: smooth;
    overscroll-behavior-x: contain;

    /* iOS momentum scrolling */
    -webkit-overflow-scrolling: touch;

    /* Scroll padding for better UX */
    scroll-padding-inline: clamp(1rem, 3vw, 2rem);

    /* Space for scrollbar underneath cards */
    padding-block-end: 12px;

    /* Scroll snap */
    scroll-snap-type: x mandatory;

    /* Performance optimization */
    contain: layout style;

    /* Styled scrollbar */
    scrollbar-width: thin;
    scrollbar-color: var(--color-blue) var(--color-neutral-100);
  }

  .artist-events-row::-webkit-scrollbar {
    height: 6px;
    -webkit-appearance: none;
  }

  .artist-events-row::-webkit-scrollbar-track {
    background: var(--color-neutral-100);
    border-radius: 0;
  }

  .artist-events-row::-webkit-scrollbar-thumb {
    background: var(--color-blue);
    border-radius: 0;
  }

  .artist-events-row::-webkit-scrollbar-thumb:hover {
    background: var(--color-green);
  }

  /* Keyboard focus indicator */
  .artist-events-row:focus-visible {
    outline: 2px solid var(--color-blue);
    outline-offset: 2px;
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .artist-events-row {
      scroll-behavior: auto;
    }
  }

  /* Content area below card - centered, max-width for readability */
  .artist-content {
    max-width: 65ch;
    width: 100%;
    margin-inline: auto;
    margin-block-end: var(--space-8);
  }

  /* Responsive: Allow smaller on narrow screens */
  @media (max-width: 520px) {
    .artist-detail-card {
      width: 90vw;
      min-width: auto;
    }

    :global(.artist-detail-card-image) {
      margin-block-start: 1rem;
      margin-inline-start: 1rem;
    }

    .artist-detail-info-box {
      margin: 1rem;
      padding: 1rem;
      gap: 0.25rem;
      max-width: 20ch;
    }
  }
</style>
