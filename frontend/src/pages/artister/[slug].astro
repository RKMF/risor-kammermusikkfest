---
import Layout from "../../layouts/Layout.astro";
import DynamicComponent from "../../components/DynamicComponent.astro";
import Image from "../../components/Image.astro";
import { getMultilingualContent } from "../../lib/utils/language.js";
import { IMAGE_QUALITY } from '../../lib/sanityImage';
import type { SanityDocument } from '@sanity/client';
import { loadQuery } from '../../lib/sanity/loadQuery.js';
import { stegaClean } from '@sanity/client/stega';
import '../../styles/event.css';

// Generate static paths for all artists
export async function getStaticPaths() {
  const { data: artists } = await loadQuery<SanityDocument[]>({
    query: `*[_type == "artist" && defined(slug.current)]`,
  });

  return artists.map((artist) => {
    return {
      params: {
        slug: artist.slug.current,
      },
    };
  });
}

const { params } = Astro;

// Fetch the specific artist based on the slug parameter
const { data: artist } = await loadQuery({
  query: `*[_type == "artist" && slug.current == $slug][0]{
    _id,
    _type,
    name,
    excerpt_no,
    excerpt_en,
    instrument_no,
    instrument_en,
    "instrument": coalesce(instrument_no, instrument_en),
    country,
    "image": {
      "image": image{
        asset->{
          _id,
          url,
          metadata {
            dimensions {
              width,
              height,
              aspectRatio
            },
            lqip,
            blurHash,
            palette {
              dominant {
                background,
                foreground
              }
            }
          }
        },
        hotspot,
        crop
      },
      "alt": coalesce(imageAlt_no, imageAlt_en, image.alt),
      "credit": coalesce(imageCredit_no, imageCredit_en)
    },
    "slug": slug.current,
    content_no,
    content_en,
    instagram,
    facebook,
    spotify,
    youtube,
    websiteUrl,
    spotifyUrl,
    instagramUrl,
    seo
  }`,
  params,
});

if (!artist) {
  return Astro.redirect('/404');
}

// Get appropriate content array
const content = getMultilingualContent(artist) || artist.content_no;
---

<Layout title={`${artist.name} - Artist`}>
  <div class="container">
    <div class="artist-detail-page">
      <!-- Artist Card - Centered, same design as list cards -->
      <div class="artist-detail-card">
        {artist.image?.image && (
          <Image
            image={artist.image.image}
            alt={stegaClean(artist.image.alt || artist.name)}
            credit={artist.image.credit ? stegaClean(artist.image.credit) : undefined}
            size="large"
            aspectRatio="4:5"
            loading="eager"
            quality={IMAGE_QUALITY.HERO}
            priority={true}
            className="artist-detail-card-image"
          />
        )}

        <div class="artist-detail-info-box">
          <h1 class="artist-name">{stegaClean(artist.name)}</h1>
          {artist.instrument && (
            <p class="artist-instrument">{stegaClean(artist.instrument)}</p>
          )}
          {artist.country && (
            <p class="artist-country"><strong>Land:</strong> {stegaClean(artist.country)}</p>
          )}
        </div>
      </div>

      <!-- Content below card -->
      {content && Array.isArray(content) && content.length > 0 && (
        <div class="artist-content">
          {content.map((block) => (
            <DynamicComponent key={block._key || block._id} block={block} />
          ))}
        </div>
      )}
    </div>
  </div>
</Layout>

<style>
  /* Green tint page background (like event pages) */
  :global(.main-content:has(.artist-detail-page)) {
    background-color: rgba(0, 179, 154, 0.08);
  }

  /* Artist Detail Page - Centered card design */
  .artist-detail-page {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-6);
    padding-block: var(--space-8);
  }

  /* Artist Detail Card - Medium centered card (480px) with Grid stacking */
  .artist-detail-card {
    /* Grid layout for stacking image and info box */
    display: grid;
    grid-template: "content" 1fr / 1fr;

    aspect-ratio: 4 / 5;
    width: 480px;
    min-width: 480px;
    max-width: 480px;
    overflow: visible;
  }

  /* Artist Image - Grid positioned, inset from top and left */
  :global(.artist-detail-card-image) {
    grid-area: content;
    justify-self: start;
    align-self: start;
    margin-block-start: 1.5rem;
    margin-inline-start: 1.5rem;
    margin-inline-end: 0; /* Override Image.astro defaults */
    margin-block-end: 0; /* Override Image.astro defaults */
    width: 85%;
    aspect-ratio: 4/5;
    overflow: hidden;
  }

  /* Artist Info Box - Grid positioned in bottom right */
  .artist-detail-info-box {
    grid-area: content;
    justify-self: end;
    align-self: end;
    margin: 1.5rem;
    background-color: var(--color-blue);
    color: white;
    padding: 1.5rem;
    display: grid;
    gap: 0.5rem;
    z-index: 2;
    width: fit-content;
    max-width: 25ch;
  }

  .artist-detail-info-box .artist-name {
    margin: 0;
    font-size: 1.25rem;
    line-height: 1.2;
    font-weight: 600;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .artist-detail-info-box .artist-instrument,
  .artist-detail-info-box .artist-country {
    margin: 0;
    font-size: 0.75rem;
    line-height: 1.3;
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: white;
    opacity: 0.9;
  }

  /* Content area below card - centered, max-width for readability */
  .artist-content {
    max-width: 65ch;
    width: 100%;
  }

  /* Responsive: Allow smaller on narrow screens */
  @media (max-width: 520px) {
    .artist-detail-card {
      width: 90vw;
      min-width: auto;
    }

    :global(.artist-detail-card-image) {
      margin-block-start: 1rem;
      margin-inline-start: 1rem;
    }

    .artist-detail-info-box {
      margin: 1rem;
      padding: 1rem;
      gap: 0.25rem;
      max-width: 20ch;
    }
  }
</style>
