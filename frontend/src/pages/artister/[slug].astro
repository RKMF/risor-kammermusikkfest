---
import Layout from "../../layouts/Layout.astro";
import DynamicComponent from "../../components/DynamicComponent.astro";
import ArtistCard from "../../components/ArtistCard.astro";
import EventCard from "../../components/EventCard.astro";
import { getMultilingualContent } from "../../lib/utils/language.js";
import { IMAGE_QUALITY } from '../../lib/sanityImage';
import type { SanityDocument } from '@sanity/client';
import { loadQuery } from '../../lib/sanity/loadQuery.js';
import { stegaClean } from '@sanity/client/stega';
import '../../styles/event.css';
import '../../styles/event-card.css';
import '../../styles/artist-card.css';

// Generate static paths for all artists
export async function getStaticPaths() {
  const { data: artists } = await loadQuery<SanityDocument[]>({
    query: `*[_type == "artist" && defined(slug.current)]`,
  });

  return artists.map((artist) => {
    return {
      params: {
        slug: artist.slug.current,
      },
    };
  });
}

const { params } = Astro;

// Fetch the specific artist based on the slug parameter
const { data: artist } = await loadQuery({
  query: `*[_type == "artist" && slug.current == $slug][0]{
    _id,
    _type,
    name,
    excerpt_no,
    excerpt_en,
    instrument_no,
    instrument_en,
    "instrument": coalesce(instrument_no, instrument_en),
    "image": {
      "image": image{
        asset->{
          _id,
          url,
          metadata {
            dimensions {
              width,
              height,
              aspectRatio
            },
            lqip,
            blurHash,
            palette {
              dominant {
                background,
                foreground
              }
            }
          }
        },
        hotspot,
        crop
      },
      "alt": coalesce(imageAlt_no, imageAlt_en, image.alt),
      "credit": coalesce(imageCredit_no, imageCredit_en)
    },
    "slug": slug.current,
    content_no,
    content_en,
    instagram,
    facebook,
    spotify,
    youtube,
    websiteUrl,
    spotifyUrl,
    instagramUrl,
    seo,
    "events": *[_type == "event" && references(^._id) && publishingStatus == "published"] | order(eventDate->date asc, eventTime.startTime asc){
      _id,
      _type,
      title_no,
      title_en,
      "title": coalesce(title_no, title_en),
      slug_no,
      slug_en,
      "slug": coalesce(slug_no.current, slug_en.current, slug.current),
      excerpt_no,
      excerpt_en,
      "excerpt": coalesce(excerpt_no, excerpt_en),
      "image": {
        "image": image{
          asset->{
            _id,
            url,
            metadata {
              dimensions {
                width,
                height,
                aspectRatio
              },
              lqip,
              blurHash,
              palette {
                dominant {
                  background,
                  foreground
                }
              }
            }
          },
          hotspot,
          crop
        },
        "alt": coalesce(imageAlt_no, imageAlt_en, image.alt),
        "credit": coalesce(imageCredit_no, imageCredit_en)
      },
      eventDate->{
        _id,
        date,
        title_display_no,
        title_display_en,
        "title": coalesce(title_display_no, title_display_en)
      },
      eventTime,
      venue->{
        _id,
        title,
        name,
        address,
        city,
        "slug": slug.current
      },
      ticketType,
      ticketUrl,
      ticketInfoText
    }
  }`,
  params,
});

if (!artist) {
  return Astro.redirect('/404');
}

// Get appropriate content array
const content = getMultilingualContent(artist) || artist.content_no;
---

<Layout title={`${artist.name} - Artist`}>
  <!-- Artist Card - Centered, medium size -->
  <div class="artist-detail-card-container">
    <ArtistCard artist={artist} language="no" size="medium" isDetailPage={true} imageSizes="480px" />
  </div>

  <!-- Excerpt -->
  {artist.excerpt_no && (
    <p class="excerpt">{stegaClean(artist.excerpt_no)}</p>
  )}

  <!-- Events Section -->
  {artist.events && artist.events.length > 0 && (
    <section class="artist-events">
      <h2 class="artist-events-title">Konserter</h2>
      <div class="scroll-container scroll-container--event-cards scroll-container--styled-scrollbar">
        {artist.events.map((event) => (
          <EventCard event={event} language="no" />
        ))}
      </div>
    </section>
  )}

  <!-- Content below card -->
  {content && Array.isArray(content) && content.length > 0 && (
    <article class="artist-content">
      {content.map((block) => (
        <DynamicComponent key={block._key || block._id} block={block} />
      ))}
    </article>
  )}
</Layout>

<style>
  /* Artist Card Container - Centered with fixed width */
  .artist-detail-card-container {
    width: 480px;
    max-width: 90vw;
    margin-inline: auto;
    margin-block-end: var(--space-6);
  }

  /* Override ArtistCard hover effects on detail page */
  .artist-detail-card-container :global(.artist-card) {
    width: 480px;
    max-width: 90vw;
    cursor: default;
  }

  /* Allow info box to grow proportionally with larger card */
  .artist-detail-card-container :global(.artist-info-box) {
    max-width: 85%; /* Same proportion as listing page, but scales to 480px card */
    padding: 1.5rem; /* Larger padding for larger card */
  }

  /* Smooth 1.1s transition from blur placeholder to sharp image */
  .artist-detail-card-container :global(.artist-card-image) {
    animation: fadeInImage 1.1s ease-in-out forwards;
  }

  @keyframes fadeInImage {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Increase font sizes proportionally to match 1.5x card growth */
  .artist-detail-card-container :global(.artist-name) {
    font-size: var(--step-3); /* 31-44px vs listing page 22-28px = ~1.5x growth */
  }

  .artist-detail-card-container :global(.artist-instrument) {
    font-size: var(--step-0); /* 18-23px vs listing page 13-14px = ~1.5x growth */
  }

  @media (hover: hover) {
    .artist-detail-card-container :global(.artist-card:hover) {
      transform: none;
      box-shadow: none;
      background-color: var(--color-tint-blue-medium);
    }

    .artist-detail-card-container :global(.artist-card:hover .artist-info-box) {
      background-color: var(--color-blue-600);
    }

    .artist-detail-card-container :global(.artist-card:hover .artist-name),
    .artist-detail-card-container :global(.artist-card:hover .artist-instrument) {
      color: var(--color-background);
    }
  }

  /* Excerpt styling handled by global .excerpt class in base.css */

  /* Events section */
  .artist-events {
    margin-block-start: var(--space-8);
    margin-block-end: var(--space-8);
  }

  .artist-events-title {
    font-size: var(--step-3);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-block-start: 0;
    margin-block-end: var(--space-6);
  }

  /* Content area below card - centered, max-width for readability */
  .artist-content {
    max-width: 65ch;
    width: 100%;
    margin-inline: auto;
    margin-block-end: var(--space-8);
  }
</style>
